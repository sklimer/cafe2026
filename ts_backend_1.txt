Техническое задание: Telegram Mini App для ресторанов
1. Введение
1.1. Назначение
Создание Telegram Mini App для приема заказов на доставку и самовывоз для ресторанов. Система включает в себя бота для взаимодействия с пользователями, мини-приложение для оформления заказов и админ-панель для управления контентом и заказами.
1.2. Цели
•	Предоставить пользователям удобный способ заказа еды через Telegram.
•	Обеспечить ресторанам инструмент для управления меню, заказами и клиентами.
•	Реализовать бонусную систему и систему промокодов для повышения лояльности.
•	Собирать аналитику по заказам и пользователям.
2. Описание системы
2.1. Компоненты системы
1.	Telegram Bot:
o	Взаимодействие с пользователем, отправка уведомлений.
o	Кнопка для открытия Mini App.
o	Команды: /start, /menu, /orders, /profile и т.д.
2.	Mini App (Frontend):
o	Страницы: меню, детали товара, корзина, оформление заказа, профиль, акции, история заказов.
o	Адаптивный дизайн под мобильные устройства.
o	Интеграция с Telegram Web App SDK.
3.	Backend (Django):
o	REST API для Mini App.
o	Обработка вебхуков от бота.
o	Админ-панель для управления данными.
o	Бизнес-логика: заказы, бонусы, промокоды, доставка.
4.	База данных (PostgreSQL):
o	Хранение данных о пользователях, ресторанах, товарах, заказах и т.д.
2.2. Сценарии использования
Сценарий 1: Пользователь запускает Mini App из бота
1.	Пользователь нажимает /start в боте.
2.	Бот приветствует и показывает кнопку "Открыть Mini App".
3.	Пользователь нажимает кнопку, открывается Mini App.
4.	Mini App отправляет initData на бэкенд для аутентификации.
5.	Бэкенд возвращает данные для отображения (меню, акции и т.д.).
Сценарий 2: Оформление заказа
1.	Пользователь выбирает товары, добавляет в корзину.
2.	Переходит в корзину, выбирает тип заказа (доставка или самовывоз).
3.	Если доставка, то выбирает адрес или добавляет новый.
4.	Выбирает время доставки/самовывоза.
5.	Применяет промокод или бонусы.
6.	Оплачивает заказ (онлайн или при получении).
7.	Получает уведомление в боте о статусе заказа.
3. Детальные требования
3.1. Бэкенд (Django)
3.1.1. Модели (основные)
•	Пользователи (User)
•	Рестораны (Restaurant)
•	Филиалы (RestaurantBranch)
•	Категории (Category)
•	Товары (Product)
•	Теги (Tag)
•	Опции товаров (ProductOption, OptionValue)
•	Заказы (Order, OrderItem)
•	Адреса доставки (UserAddress)
•	Бонусы (BonusRule, UserBonusTransaction)
•	Промокоды (PromoCode)
•	Акции (Promotion)
•	Рассылки (Newsletter)
•	События пользователей (UserEvent)
•	Логи (PaymentLog, AdminAuditLog)
3.1.2. API Endpoints
Аутентификация
•	POST /api/v1/auth/telegram/ - аутентификация через Telegram initData
Пользователь
•	GET /api/v1/profile/ - профиль пользователя
•	PUT /api/v1/profile/ - обновление профиля
Рестораны и филиалы
•	GET /api/v1/restaurants/ - список ресторанов
•	GET /api/v1/restaurants/{id}/branches/ - филиалы ресторана
Меню
•	GET /api/v1/restaurants/{id}/categories/ - категории ресторана
•	GET /api/v1/categories/{id}/products/ - товары категории
•	GET /api/v1/products/{id}/ - детали товара
Корзина
•	GET /api/v1/cart/ - получение корзины
•	POST /api/v1/cart/add/ - добавление товара в корзину
•	PUT /api/v1/cart/update/{item_id}/ - обновление товара в корзине
•	DELETE /api/v1/cart/remove/{item_id}/ - удаление товара из корзины
Заказы
•	POST /api/v1/orders/ - создание заказа
•	GET /api/v1/orders/ - история заказов
•	GET /api/v1/orders/{id}/ - детали заказа
Адреса
•	GET /api/v1/addresses/ - список адресов пользователя
•	POST /api/v1/addresses/ - добавление адреса
•	PUT /api/v1/addresses/{id}/ - обновление адреса
•	DELETE /api/v1/addresses/{id}/ - удаление адреса
Бонусы и промокоды
•	GET /api/v1/bonus/balance/ - баланс бонусов
•	GET /api/v1/bonus/transactions/ - история бонусных транзакций
•	POST /api/v1/promo/validate/ - проверка промокода
3.1.3. Админ-панель
Админ-панель должна включать управление всеми моделями, в том числе:
•	Управление ресторанами и филиалами: добавление, редактирование, настройка времени работы, условий доставки.
•	Управление меню: категории, товары, теги, опции.
•	Управление заказами: просмотр, изменение статуса, отмена.
•	Управление пользователями: просмотр, блокировка, редактирование.
•	Управление бонусной системой: настройка правил, просмотр транзакций.
•	Управление промокодами и акциями: создание, редактирование, отслеживание использования.
•	Рассылки: создание и отправка рассылок пользователям.
•	Аналитика: просмотр статистики по заказам, пользователям, ресторанам.
3.2. Фронтенд (Mini App)
3.2.1. Страницы
1.	Главная (Меню):
o	Список категорий ресторана.
o	Список товаров в категории.
o	Фильтрация по тегам (новинка, хит и т.д.).
2.	Детали товара:
o	Изображение, название, описание, цена.
o	Выбор опций (если есть).
o	Добавление в корзину.
3.	Корзина:
o	Список выбранных товаров с опциями.
o	Возможность изменить количество или удалить.
o	Итоговая сумма.
4.	Оформление заказа:
o	Выбор типа заказа (доставка/самовывоз).
o	Для доставки: выбор адреса или добавление нового.
o	Выбор времени доставки/самовывоза.
o	Применение промокода.
o	Использование бонусов.
o	Выбор способа оплаты.
o	Подтверждение заказа.
5.	Профиль:
o	Информация о пользователе (Telegram ID, дата регистрации).
o	История заказов.
o	Бонусный баланс.
o	Реферальная ссылка.
o	Настройки (рассылки).
6.	Акции:
o	Список активных акций.
7.	История заказов:
o	Список заказов с статусами.
o	Детали заказа.
3.2.2. Технические требования
•	Использование React с TypeScript.
•	Адаптивная верстка (мобильные устройства).
•	Интеграция с Telegram Web App SDK для:
o	Авторизации (initData)
o	Закрытия приложения
o	Изменения размеров окна
o	Отправки данных в бота (при необходимости)
3.3. Бот (Telegram Bot)
3.3.1. Команды
•	/start – приветствие, регистрация, кнопка открытия Mini App.
•	/menu – открыть меню (ссылка на Mini App).
•	/orders – история заказов (ссылка на Mini App).
•	/profile – профиль (ссылка на Mini App).
•	/help – помощь.
3.3.2. Уведомления
•	При изменении статуса заказа.
•	При начислении бонусов.
•	Рассылки (если пользователь подписан).
3.3.3. Взаимодействие с Mini App
•	Бот открывает Mini App по кнопке.
•	Mini App может отправлять данные в бота (например, подтверждение заказа).
4. Безопасность
1.	Аутентификация через Telegram: проверка initData на сервере.
2.	JWT токены для доступа к API.
3.	Валидация данных на стороне сервера.
4.	Защита от SQL-инъекций (использование ORM).
5.	Ограничение запросов (rate limiting) для API.
5. Развертывание и инфраструктура
5.1. Серверные требования
•	Python 3.10+
•	PostgreSQL 18+
•	Redis (для кеширования и Celery)
5.2. Контейнеризация (Docker)
•	Docker-образ для бэкенда.
•	Docker-образ для фронтенда (если нужно).
•	Docker-compose для локальной разработки и развертывания.
5.3. CI/CD
•	Автоматические тесты (pytest для бэкенда, Jest для фронтенда).
•	Автоматическое развертывание при пуше в ветку main.
6. Документация
6.1. Для разработчиков
•	Описание API (Swagger/OpenAPI).
•	Инструкция по запуску проекта локально.
•	Описание архитектуры.
6.2. Для администраторов
•	Руководство по использованию админ-панели.
•	Инструкция по управлению ресторанами и заказами.
7. Тестирование
1.	Юнит-тесты для бэкенда (Django).
2.	Интеграционные тесты для API.
3.	Тесты фронтенда (Jest, React Testing Library).
4.	E2E тесты (Cypress).
________________________________________
Это ТЗ описывает полную систему. Разработчик должен следовать этому документу для реализации проекта.
ПОЛНОЕ ТЕХНИЧЕСКОЕ ЗАДАНИЕ: Telegram Mini App для ресторанов с мультиресторанной системой
1. ОБЩЕЕ ОПИСАНИЕ ПРОЕКТА
1.1. Цель проекта
Создание комплексной системы для ресторанов с Telegram-интерфейсом, включающей:
•	Мультиресторанную платформу для управления несколькими заведениями
•	Telegram Mini App для клиентов с заказом доставки/самовывоза
•	Административную панель для полного управления бизнес-процессами
•	Интегрированную бонусную систему и кешбек
•	Систему аналитики и CRM для учета клиентов
1.2. Бизнес-задачи
1.	Для ресторанов: Увеличение заказов через Telegram, снижение нагрузки на кол-центр
2.	Для клиентов: Удобный заказ из мессенджера, бонусная программа, история заказов
3.	Для администраторов: Полный контроль над меню, заказами, клиентами и аналитикой
1.3. Ключевые особенности
•	Мультиресторанность: Поддержка нескольких ресторанов и филиалов
•	Два типа заказов: Доставка и самовывоз с разной логикой
•	Гибкое меню: Категории, опции, теги, атрибуты товаров
•	Бонусная система: Начисления за регистрацию, заказы, персональные акции
•	Кешбек: Процент от суммы заказа возвращается на бонусный счет
•	Геолокация: Расчет зон доставки, расстояний, стоимости
•	Аналитика: Полная статистика по заказам, клиентам, выручке
2. ТЕХНОЛОГИЧЕСКИЙ СТЕК
2.1. Backend (Django 4.x)
yaml
Фреймворки:
  - Django 4.x + Django REST Framework
  - Django Channels (для вебсокетов)
  - Celery + Redis (для асинхронных задач)
  - Django ORM + PostgreSQL

Библиотеки:
  - python-telegram-bot 20.x
  - django-telegram-login (для валидации initData)
  - djoser (для JWT аутентификации)
  - django-filter (для фильтрации API)
  - drf-yasg (для Swagger документации)
  - django-cors-headers (для CORS)
  - django-cacheops (для кэширования)
  - django-prometheus (для метрик)
2.2. Database (PostgreSQL 18+)
sql
Расширения:
  - PostGIS (для геолокационных запросов)
  - pg_trgm (для полнотекстового поиска)
  - btree_gin (для составных индексов)
  - timescaledb (для временных рядов аналитики)

Конфигурация:
  - Размер БД: 10GB начально, с автоматическим расширением
  - Репликация: Master-Slave для чтения аналитики
  - Бэкапы: Ежедневные + инкрементальные
2.3. Frontend (Telegram Mini App)
javascript
Стек:
  - React 18 с TypeScript
  - Vite как сборщик
  - Zustand/Redux Toolkit для состояния
  - React Router v6 для навигации
  - Tailwind CSS для стилей
  - React Query для работы с API
  - Framer Motion для анимаций

Интеграции:
  - Telegram WebApp SDK
  - Yandex Maps API / Google Maps API
  - Payment API (ЮKassa, CloudPayments)
  - Sentry для мониторинга ошибок
2.4. DevOps
yaml
Инфраструктура:
  - Docker + Docker Compose
  - Nginx как reverse proxy
  - Gunicorn/Uvicorn для ASGI
  - Redis для кэша и Celery
  - MinIO для хранения файлов

Мониторинг:
  - Prometheus + Grafana
  - ELK Stack для логов
  - Sentry для ошибок
  - Uptime Robot для доступности

CI/CD:
  - GitHub Actions
  - Docker Hub для образов
  - Автоматическое тестирование и деплой
3. ПОЛНАЯ АРХИТЕКТУРА БАЗЫ ДАННЫХ
3.1. Core Tables (Ядро системы)
3.1.1. Users & Authentication
sql
-- Extended user model with referral system
CREATE TABLE users (
    id BIGSERIAL PRIMARY KEY,
    telegram_id BIGINT UNIQUE NOT NULL,
    username VARCHAR(255),
    first_name VARCHAR(255) NOT NULL,
    last_name VARCHAR(255),
    phone VARCHAR(50) UNIQUE,
    email VARCHAR(255) UNIQUE,
    language_code VARCHAR(10) DEFAULT 'ru',

    -- Business metrics
    total_orders INT DEFAULT 0,
    total_spent DECIMAL(10,2) DEFAULT 0,
    bonus_balance DECIMAL(10,2) DEFAULT 0,
    bonus_percent_allowed INT DEFAULT 10,

    -- Status flags
    is_active BOOLEAN DEFAULT TRUE,
    is_blocked BOOLEAN DEFAULT FALSE,
    is_premium BOOLEAN DEFAULT FALSE,
    email_verified BOOLEAN DEFAULT FALSE,
    phone_verified BOOLEAN DEFAULT FALSE,

    -- Referral system
    referral_code VARCHAR(50) UNIQUE,
    referred_by BIGINT REFERENCES users(id),
    referral_count INT DEFAULT 0,

    -- Preferences (JSON for flexibility)
    notification_preferences JSONB DEFAULT '{
        "order_updates": true,
        "promotions": true,
        "newsletter": false,
        "push": true,
        "email": false,
        "sms": false
    }',

    settings JSONB DEFAULT '{
        "default_order_type": "delivery",
        "save_order_history": true,
        "save_addresses": true,
        "theme": "light",
        "currency": "RUB"
    }',

    -- Timestamps
    registration_date TIMESTAMP DEFAULT NOW(),
    last_login TIMESTAMP DEFAULT NOW(),
    last_activity TIMESTAMP DEFAULT NOW(),
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

-- User addresses with geolocation
CREATE TABLE user_addresses (
    id BIGSERIAL PRIMARY KEY,
    user_id BIGINT REFERENCES users(id) ON DELETE CASCADE,
    alias VARCHAR(100) NOT NULL DEFAULT 'Дом',
    address TEXT NOT NULL,
    city VARCHAR(100),
    street VARCHAR(255),
    house VARCHAR(50),
    entrance VARCHAR(20),
    floor VARCHAR(20),
    apartment VARCHAR(20),
    intercom VARCHAR(20),
    comment TEXT,

    -- Geolocation for distance calculations
    latitude DECIMAL(10,8),
    longitude DECIMAL(11,8),
    geolocation_accuracy VARCHAR(50),

    -- Status
    is_default BOOLEAN DEFAULT FALSE,
    is_verified BOOLEAN DEFAULT FALSE,

    -- Metadata
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW(),

    -- Indexes
    INDEX idx_user_addresses_user_id (user_id),
    INDEX idx_user_addresses_geolocation (latitude, longitude),
    INDEX idx_user_addresses_default (user_id, is_default)
);
3.1.2. Restaurants & Branches Management
sql
-- Restaurant chain management
CREATE TABLE restaurants (
    id BIGSERIAL PRIMARY KEY,
    name VARCHAR(255) NOT NULL,
    slug VARCHAR(100) UNIQUE NOT NULL,
    description TEXT,
    logo_url TEXT,
    cover_url TEXT,
    website VARCHAR(255),

    -- Contact info
    contact_phone VARCHAR(50),
    contact_email VARCHAR(255),
    support_phone VARCHAR(50),

    -- Business info
    legal_name VARCHAR(255),
    inn VARCHAR(20),
    kpp VARCHAR(20),
    ogrn VARCHAR(20),
    legal_address TEXT,

    -- Settings
    timezone VARCHAR(50) DEFAULT 'Europe/Moscow',
    currency VARCHAR(3) DEFAULT 'RUB',
    default_language VARCHAR(10) DEFAULT 'ru',

    -- Status
    is_active BOOLEAN DEFAULT TRUE,
    is_featured BOOLEAN DEFAULT FALSE,
    verification_status VARCHAR(50) DEFAULT 'pending',

    -- Metadata
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW(),

    -- Indexes
    INDEX idx_restaurants_slug (slug),
    INDEX idx_restaurants_active (is_active),
    INDEX idx_restaurants_featured (is_featured)
);

-- Branches with individual settings
CREATE TABLE restaurant_branches (
    id BIGSERIAL PRIMARY KEY,
    restaurant_id BIGINT REFERENCES restaurants(id) ON DELETE CASCADE,
    name VARCHAR(255) NOT NULL,
    slug VARCHAR(100) UNIQUE NOT NULL,
    address TEXT NOT NULL,
    city VARCHAR(100) NOT NULL,
    district VARCHAR(100),

    -- Geolocation
    latitude DECIMAL(10,8) NOT NULL,
    longitude DECIMAL(11,8) NOT NULL,

    -- Contact info
    phone VARCHAR(50),
    email VARCHAR(255),
    manager_name VARCHAR(255),
    manager_phone VARCHAR(50),

    -- Business hours (JSON для гибкости)
    business_hours JSONB NOT NULL DEFAULT '{
        "monday": {"pickup": {"start": "09:00", "end": "23:00"}, "delivery": {"start": "10:00", "end": "22:00"}},
        "tuesday": {"pickup": {"start": "09:00", "end": "23:00"}, "delivery": {"start": "10:00", "end": "22:00"}},
        "wednesday": {"pickup": {"start": "09:00", "end": "23:00"}, "delivery": {"start": "10:00", "end": "22:00"}},
        "thursday": {"pickup": {"start": "09:00", "end": "23:00"}, "delivery": {"start": "10:00", "end": "22:00"}},
        "friday": {"pickup": {"start": "09:00", "end": "00:00"}, "delivery": {"start": "10:00", "end": "23:00"}},
        "saturday": {"pickup": {"start": "10:00", "end": "00:00"}, "delivery": {"start": "11:00", "end": "23:00"}},
        "sunday": {"pickup": {"start": "10:00", "end": "22:00"}, "delivery": {"start": "11:00", "end": "21:00"}}
    }',

    -- Order settings
    min_order_amount DECIMAL(10,2) DEFAULT 0,
    max_order_amount DECIMAL(10,2),
    preparation_time_min INT DEFAULT 30,
    preparation_time_max INT DEFAULT 60,

    -- Delivery settings
    delivery_fee DECIMAL(10,2) DEFAULT 0,
    delivery_radius_meters INT DEFAULT 5000,
    free_delivery_threshold DECIMAL(10,2),
    delivery_fee_ranges JSONB DEFAULT '[{"min_distance": 0, "max_distance": 2000, "fee": 100}, {"min_distance": 2000, "max_distance": 5000, "fee": 200}]',

    -- Payment methods
    accepted_payment_methods JSONB DEFAULT '["cash", "card_online", "card_upon_receipt", "sbp"]',

    -- Status
    is_active BOOLEAN DEFAULT TRUE,
    is_accepting_orders BOOLEAN DEFAULT TRUE,
    is_accepting_delivery BOOLEAN DEFAULT TRUE,
    is_accepting_pickup BOOLEAN DEFAULT TRUE,

    -- Kitchen settings
    kitchen_type VARCHAR(100),
    cuisines JSONB DEFAULT '[]',
    special_features JSONB DEFAULT '[]',

    -- Metadata
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW(),

    -- Indexes
    INDEX idx_branches_restaurant (restaurant_id),
    INDEX idx_branches_city (city),
    INDEX idx_branches_geolocation (latitude, longitude),
    INDEX idx_branches_active (is_active),
    INDEX idx_branches_accepting_orders (is_accepting_orders)
);

-- Delivery zones for complex geography
CREATE TABLE delivery_zones (
    id BIGSERIAL PRIMARY KEY,
    restaurant_branch_id BIGINT REFERENCES restaurant_branches(id) ON DELETE CASCADE,
    name VARCHAR(100) NOT NULL,

    -- Zone geometry (using PostGIS if available)
    polygon_coordinates JSONB NOT NULL,

    -- Delivery parameters
    delivery_fee DECIMAL(10,2) NOT NULL,
    min_delivery_time INT DEFAULT 30,
    max_delivery_time INT DEFAULT 60,
    free_delivery_threshold DECIMAL(10,2),

    -- Status
    is_active BOOLEAN DEFAULT TRUE,

    -- Metadata
    created_at TIMESTAMP DEFAULT NOW(),

    -- Indexes
    INDEX idx_delivery_zones_branch (restaurant_branch_id),
    INDEX idx_delivery_zones_active (is_active)
);
3.1.3. Menu & Catalog System
sql
-- Categories hierarchy
CREATE TABLE categories (
    id BIGSERIAL PRIMARY KEY,
    restaurant_id BIGINT REFERENCES restaurants(id) ON DELETE CASCADE,
    parent_id BIGINT REFERENCES categories(id),
    name VARCHAR(255) NOT NULL,
    description TEXT,
    image_url TEXT,
    icon_url TEXT,

    -- Display settings
    display_order INT DEFAULT 0,
    is_featured BOOLEAN DEFAULT FALSE,
    is_visible BOOLEAN DEFAULT TRUE,

    -- Filters
    filter_attributes JSONB DEFAULT '{}',

    -- Status
    is_active BOOLEAN DEFAULT TRUE,

    -- Metadata
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW(),

    -- Indexes
    INDEX idx_categories_restaurant (restaurant_id),
    INDEX idx_categories_parent (parent_id),
    INDEX idx_categories_order (restaurant_id, display_order),
    INDEX idx_categories_active (is_active)
);

-- Products with extended attributes
CREATE TABLE products (
    id BIGSERIAL PRIMARY KEY,
    restaurant_id BIGINT REFERENCES restaurants(id) ON DELETE CASCADE,
    category_id BIGINT REFERENCES categories(id) ON DELETE SET NULL,

    -- Basic info
    name VARCHAR(255) NOT NULL,
    description TEXT,
    short_description VARCHAR(500),

    -- Pricing
    price DECIMAL(10,2) NOT NULL,
    old_price DECIMAL(10,2),
    cost_price DECIMAL(10,2),
    profit_margin DECIMAL(5,2),

    -- Stock management
    is_available BOOLEAN DEFAULT TRUE,
    stock_quantity INT,
    low_stock_threshold INT DEFAULT 10,
    is_unlimited_stock BOOLEAN DEFAULT FALSE,

    -- Product attributes
    weight_grams INT,
    volume_ml INT,
    calories INT,
    proteins DECIMAL(5,2),
    fats DECIMAL(5,2),
    carbohydrates DECIMAL(5,2),

    -- Media
    main_image_url TEXT,
    image_urls TEXT[] DEFAULT '{}',
    video_url TEXT,

    -- Flags
    is_popular BOOLEAN DEFAULT FALSE,
    is_new BOOLEAN DEFAULT FALSE,
    is_recommended BOOLEAN DEFAULT FALSE,
    is_spicy BOOLEAN DEFAULT FALSE,
    is_vegetarian BOOLEAN DEFAULT FALSE,
    is_vegan BOOLEAN DEFAULT FALSE,
    is_gluten_free BOOLEAN DEFAULT FALSE,

    -- Preparation
    cooking_time_minutes INT,
    preparation_instructions TEXT,

    -- Display
    display_order INT DEFAULT 0,
    seo_title VARCHAR(255),
    seo_description TEXT,
    seo_keywords TEXT[],

    -- Custom attributes
    custom_attributes JSONB DEFAULT '{}',

    -- Metadata
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW(),

    -- Indexes
    INDEX idx_products_restaurant (restaurant_id),
    INDEX idx_products_category (category_id),
    INDEX idx_products_available (restaurant_id, is_available),
    INDEX idx_products_price (price),
    INDEX idx_products_popular (is_popular),
    INDEX idx_products_new (is_new),
    INDEX idx_products_search (name, description)
);

-- Tags system
CREATE TABLE tags (
    id BIGSERIAL PRIMARY KEY,
    restaurant_id BIGINT REFERENCES restaurants(id) ON DELETE CASCADE,
    name VARCHAR(100) NOT NULL,
    description TEXT,
    color VARCHAR(7) DEFAULT '#FF6B35',
    icon_url TEXT,
    text_color VARCHAR(7) DEFAULT '#FFFFFF',

    -- Display
    display_order INT DEFAULT 0,

    -- Status
    is_active BOOLEAN DEFAULT TRUE,

    -- Metadata
    created_at TIMESTAMP DEFAULT NOW(),

    -- Indexes
    INDEX idx_tags_restaurant (restaurant_id),
    INDEX idx_tags_name (name),
    UNIQUE(restaurant_id, name)
);

-- Product-tag relations
CREATE TABLE product_tags (
    product_id BIGINT REFERENCES products(id) ON DELETE CASCADE,
    tag_id BIGINT REFERENCES tags(id) ON DELETE CASCADE,
    created_at TIMESTAMP DEFAULT NOW(),

    PRIMARY KEY (product_id, tag_id)
);

-- Product options system
CREATE TABLE product_options (
    id BIGSERIAL PRIMARY KEY,
    restaurant_id BIGINT REFERENCES restaurants(id) ON DELETE CASCADE,
    name VARCHAR(255) NOT NULL,
    description TEXT,

    -- Option type
    option_type VARCHAR(50) NOT NULL CHECK (
        option_type IN ('single_choice', 'multiple_choice', 'quantity', 'boolean')
    ),

    -- Selection rules
    is_required BOOLEAN DEFAULT FALSE,
    min_selection INT DEFAULT 1,
    max_selection INT DEFAULT 1,
    default_value TEXT,

    -- Display
    display_order INT DEFAULT 0,
    help_text TEXT,

    -- Status
    is_active BOOLEAN DEFAULT TRUE,

    -- Metadata
    created_at TIMESTAMP DEFAULT NOW(),

    -- Indexes
    INDEX idx_product_options_restaurant (restaurant_id),
    INDEX idx_product_options_type (option_type),
    INDEX idx_product_options_active (is_active)
);

-- Option values
CREATE TABLE option_values (
    id BIGSERIAL PRIMARY KEY,
    option_id BIGINT REFERENCES product_options(id) ON DELETE CASCADE,
    value VARCHAR(255) NOT NULL,
    description TEXT,

    -- Pricing
    price_modifier DECIMAL(10,2) DEFAULT 0,
    cost_modifier DECIMAL(10,2) DEFAULT 0,

    -- Stock
    is_available BOOLEAN DEFAULT TRUE,
    stock_quantity INT,

    -- Display
    display_order INT DEFAULT 0,
    is_default BOOLEAN DEFAULT FALSE,
    color VARCHAR(7),
    icon_url TEXT,

    -- Metadata
    created_at TIMESTAMP DEFAULT NOW(),

    -- Indexes
    INDEX idx_option_values_option (option_id),
    INDEX idx_option_values_available (is_available),
    UNIQUE(option_id, value)
);

-- Product-option relations
CREATE TABLE product_available_options (
    product_id BIGINT REFERENCES products(id) ON DELETE CASCADE,
    option_id BIGINT REFERENCES product_options(id) ON DELETE CASCADE,
    created_at TIMESTAMP DEFAULT NOW(),

    PRIMARY KEY (product_id, option_id)
);
3.1.4. Orders & Delivery System
sql
-- Orders main table
CREATE TABLE orders (
    id BIGSERIAL PRIMARY KEY,

    -- Order identification
    order_number VARCHAR(50) UNIQUE NOT NULL,
    external_id VARCHAR(100),

    -- User information
    user_id BIGINT REFERENCES users(id) ON DELETE SET NULL,
    user_telegram_id BIGINT,
    user_name VARCHAR(255),
    user_phone VARCHAR(50) NOT NULL,
    user_email VARCHAR(255),

    -- Restaurant information
    restaurant_branch_id BIGINT REFERENCES restaurant_branches(id) ON DELETE SET NULL,
    restaurant_name VARCHAR(255),
    branch_name VARCHAR(255),

    -- Order type and status
    order_type VARCHAR(20) NOT NULL CHECK (order_type IN ('delivery', 'pickup')),
    status VARCHAR(50) NOT NULL DEFAULT 'pending' CHECK (
        status IN ('pending', 'confirmed', 'preparing', 'ready',
                  'delivering', 'delivered', 'picked_up',
                  'cancelled', 'refunded', 'failed')
    ),

    -- Delivery information (for delivery orders)
    delivery_address_id BIGINT REFERENCES user_addresses(id) ON DELETE SET NULL,
    delivery_address TEXT,
    delivery_latitude DECIMAL(10,8),
    delivery_longitude DECIMAL(11,8),
    delivery_distance_meters INT,
    delivery_zone_id BIGINT REFERENCES delivery_zones(id),

    -- Time slots
    preferred_delivery_time TIMESTAMP,
    delivery_time_slot VARCHAR(100),
    actual_delivery_time TIMESTAMP,

    -- Pickup information (for pickup orders)
    pickup_time TIMESTAMP,
    actual_pickup_time TIMESTAMP,

    -- Pricing
    subtotal DECIMAL(10,2) NOT NULL,
    delivery_fee DECIMAL(10,2) DEFAULT 0,
    service_fee DECIMAL(10,2) DEFAULT 0,
    packaging_fee DECIMAL(10,2) DEFAULT 0,
    discount_amount DECIMAL(10,2) DEFAULT 0,
    bonus_used DECIMAL(10,2) DEFAULT 0,
    total_amount DECIMAL(10,2) NOT NULL,
    tips_amount DECIMAL(10,2) DEFAULT 0,

    -- Discounts and bonuses
    promo_code_id BIGINT,
    promo_code VARCHAR(100),
    promo_discount_amount DECIMAL(10,2) DEFAULT 0,
    bonus_percent_used INT DEFAULT 0,
    bonus_earned DECIMAL(10,2) DEFAULT 0,

    -- Payment information
    payment_method VARCHAR(50) NOT NULL,
    payment_status VARCHAR(50) DEFAULT 'pending' CHECK (
        payment_status IN ('pending', 'processing', 'paid', 'failed', 'refunded', 'cancelled')
    ),
    payment_provider VARCHAR(100),
    payment_id VARCHAR(255),
    payment_url TEXT,

    -- Courier information (for delivery)
    courier_id BIGINT,
    courier_name VARCHAR(255),
    courier_phone VARCHAR(50),
    courier_vehicle VARCHAR(50),
    courier_tracking_url TEXT,

    -- Preparation and delivery estimates
    estimated_preparation_time TIMESTAMP,
    estimated_delivery_time TIMESTAMP,
    preparation_duration_minutes INT,
    delivery_duration_minutes INT,

    -- Notes and comments
    customer_comment TEXT,
    special_instructions TEXT,
    restaurant_notes TEXT,
    cancellation_reason TEXT,

    -- Metadata
    source VARCHAR(50) DEFAULT 'telegram_mini_app',
    device_info JSONB,
    ip_address INET,
    user_agent TEXT,

    -- Timestamps
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW(),
    confirmed_at TIMESTAMP,
    prepared_at TIMESTAMP,
    dispatched_at TIMESTAMP,
    completed_at TIMESTAMP,
    cancelled_at TIMESTAMP,

    -- Check constraints
    CHECK (
        (order_type = 'delivery' AND delivery_address IS NOT NULL) OR
        (order_type = 'pickup' AND restaurant_branch_id IS NOT NULL)
    ),

    -- Indexes
    INDEX idx_orders_user (user_id),
    INDEX idx_orders_branch (restaurant_branch_id),
    INDEX idx_orders_status (status),
    INDEX idx_orders_payment_status (payment_status),
    INDEX idx_orders_created (created_at),
    INDEX idx_orders_number (order_number),
    INDEX idx_orders_user_telegram (user_telegram_id),
    INDEX idx_orders_type_status (order_type, status),
    INDEX idx_orders_dates (created_at, completed_at)
);

-- Order items with options
CREATE TABLE order_items (
    id BIGSERIAL PRIMARY KEY,
    order_id BIGINT REFERENCES orders(id) ON DELETE CASCADE,
    product_id BIGINT REFERENCES products(id) ON DELETE SET NULL,

    -- Product info at time of order
    product_name VARCHAR(255) NOT NULL,
    product_description TEXT,
    product_price DECIMAL(10,2) NOT NULL,

    -- Quantity and pricing
    quantity INT NOT NULL DEFAULT 1,
    unit_price DECIMAL(10,2) NOT NULL,
    subtotal DECIMAL(10,2) NOT NULL,

    -- Options selected
    selected_options JSONB DEFAULT '[]',
    options_modifier DECIMAL(10,2) DEFAULT 0,

    -- Special requests
    special_instructions TEXT,

    -- Status
    is_prepared BOOLEAN DEFAULT FALSE,
    prepared_at TIMESTAMP,

    -- Metadata
    created_at TIMESTAMP DEFAULT NOW(),

    -- Indexes
    INDEX idx_order_items_order (order_id),
    INDEX idx_order_items_product (product_id)
);

-- Order status history
CREATE TABLE order_status_history (
    id BIGSERIAL PRIMARY KEY,
    order_id BIGINT REFERENCES orders(id) ON DELETE CASCADE,

    -- Status change
    old_status VARCHAR(50),
    new_status VARCHAR(50) NOT NULL,

    -- Who changed
    changed_by_type VARCHAR(50) CHECK (changed_by_type IN ('system', 'admin', 'user', 'restaurant', 'courier')),
    changed_by_id BIGINT,
    changed_by_name VARCHAR(255),

    -- Reason and notes
    reason TEXT,
    notes TEXT,

    -- Metadata
    created_at TIMESTAMP DEFAULT NOW(),

    -- Indexes
    INDEX idx_order_status_history_order (order_id),
    INDEX idx_order_status_history_created (created_at),
    INDEX idx_order_status_history_new_status (new_status)
);

-- Delivery time slots management
CREATE TABLE delivery_time_slots (
    id BIGSERIAL PRIMARY KEY,
    restaurant_branch_id BIGINT REFERENCES restaurant_branches(id) ON DELETE CASCADE,

    -- Slot definition
    slot_date DATE NOT NULL,
    slot_type VARCHAR(50) NOT NULL CHECK (slot_type IN ('delivery', 'pickup')),
    start_time TIME NOT NULL,
    end_time TIME NOT NULL,
    slot_label VARCHAR(100),

    -- Capacity
    max_orders INT DEFAULT 20,
    booked_orders INT DEFAULT 0,

    -- Pricing
    surcharge DECIMAL(10,2) DEFAULT 0,

    -- Availability
    is_available BOOLEAN DEFAULT TRUE,
    is_peak_hour BOOLEAN DEFAULT FALSE,

    -- Metadata
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW(),

    -- Constraints
    UNIQUE(restaurant_branch_id, slot_date, slot_type, start_time),

    -- Indexes
    INDEX idx_delivery_slots_branch (restaurant_branch_id),
    INDEX idx_delivery_slots_date (slot_date),
    INDEX idx_delivery_slots_available (is_available),
    INDEX idx_delivery_slots_daterange (slot_date, start_time, end_time)
);
3.1.5. Bonus & Loyalty System
sql
-- Bonus rules configuration
CREATE TABLE bonus_rules (
    id BIGSERIAL PRIMARY KEY,
    name VARCHAR(255) NOT NULL,
    description TEXT,
    rule_type VARCHAR(50) NOT NULL CHECK (
        rule_type IN ('registration', 'first_order', 'order_count',
                     'order_amount', 'referral', 'birthday',
                     'anniversary', 'custom')
    ),

    -- Conditions (JSON для гибкости)
    conditions JSONB NOT NULL DEFAULT '{}',

    -- Reward
    bonus_amount DECIMAL(10,2) NOT NULL,
    bonus_type VARCHAR(50) DEFAULT 'fixed' CHECK (bonus_type IN ('fixed', 'percentage')),
    max_bonus_amount DECIMAL(10,2),

    -- Usage limits
    max_uses_per_user INT,
    total_max_uses INT,
    used_count INT DEFAULT 0,

    -- Target audience
    target_user_segment JSONB DEFAULT '{}',
    target_restaurants JSONB DEFAULT '{}',
    target_categories JSONB DEFAULT '{}',
    target_products JSONB DEFAULT '{}',

    -- Validity
    valid_from TIMESTAMP DEFAULT NOW(),
    valid_to TIMESTAMP,
    priority INT DEFAULT 0,

    -- Status
    is_active BOOLEAN DEFAULT TRUE,
    is_automatic BOOLEAN DEFAULT TRUE,

    -- Metadata
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW(),

    -- Indexes
    INDEX idx_bonus_rules_type (rule_type),
    INDEX idx_bonus_rules_active (is_active),
    INDEX idx_bonus_rules_validity (valid_from, valid_to),
    INDEX idx_bonus_rules_priority (priority)
);

-- Bonus transactions
CREATE TABLE user_bonus_transactions (
    id BIGSERIAL PRIMARY KEY,
    user_id BIGINT REFERENCES users(id) ON DELETE CASCADE,
    order_id BIGINT REFERENCES orders(id) ON DELETE SET NULL,
    bonus_rule_id BIGINT REFERENCES bonus_rules(id) ON DELETE SET NULL,

    -- Transaction details
    transaction_type VARCHAR(50) NOT NULL CHECK (
        transaction_type IN ('earned', 'spent', 'expired',
                           'manual_adjustment', 'correction')
    ),
    amount DECIMAL(10,2) NOT NULL,
    description TEXT,

    -- Balance
    balance_before DECIMAL(10,2) NOT NULL,
    balance_after DECIMAL(10,2) NOT NULL,

    -- Validity
    expires_at TIMESTAMP,
    is_expired BOOLEAN DEFAULT FALSE,

    -- Metadata
    created_by VARCHAR(100),
    notes TEXT,
    created_at TIMESTAMP DEFAULT NOW(),

    -- Indexes
    INDEX idx_bonus_transactions_user (user_id),
    INDEX idx_bonus_transactions_order (order_id),
    INDEX idx_bonus_transactions_type (transaction_type),
    INDEX idx_bonus_transactions_expires (expires_at),
    INDEX idx_bonus_transactions_created (created_at)
);

-- Promo codes system
CREATE TABLE promo_codes (
    id BIGSERIAL PRIMARY KEY,
    code VARCHAR(100) UNIQUE NOT NULL,
    name VARCHAR(255),
    description TEXT,

    -- Discount type
    discount_type VARCHAR(50) NOT NULL CHECK (
        discount_type IN ('percentage', 'fixed_amount', 'free_delivery',
                         'buy_x_get_y', 'gift_product')
    ),
    discount_value DECIMAL(10,2),
    max_discount_amount DECIMAL(10,2),

    -- Conditions
    min_order_amount DECIMAL(10,2) DEFAULT 0,
    max_order_amount DECIMAL(10,2),
    applicable_order_types JSONB DEFAULT '["delivery", "pickup"]',
    applicable_payment_methods JSONB DEFAULT '["cash", "card_online", "card_upon_receipt", "sbp"]',

    -- Usage limits
    max_uses_total INT,
    max_uses_per_user INT,
    used_count INT DEFAULT 0,

    -- Validity
    valid_from TIMESTAMP DEFAULT NOW(),
    valid_to TIMESTAMP,

    -- Target restrictions
    for_new_users_only BOOLEAN DEFAULT FALSE,
    for_existing_users_only BOOLEAN DEFAULT FALSE,
    user_ids_whitelist JSONB DEFAULT '[]',
    user_ids_blacklist JSONB DEFAULT '[]',
    restaurant_branch_ids JSONB DEFAULT '[]',
    category_ids JSONB DEFAULT '[]',
    product_ids JSONB DEFAULT '[]',

    -- Status
    is_active BOOLEAN DEFAULT TRUE,
    is_public BOOLEAN DEFAULT TRUE,

    -- Metadata
    created_by BIGINT REFERENCES users(id),
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW(),

    -- Indexes
    INDEX idx_promo_codes_code (code),
    INDEX idx_promo_codes_active (is_active),
    INDEX idx_promo_codes_validity (valid_from, valid_to),
    INDEX idx_promo_codes_discount_type (discount_type)
);

-- Promo code usage tracking
CREATE TABLE promo_code_uses (
    id BIGSERIAL PRIMARY KEY,
    promo_code_id BIGINT REFERENCES promo_codes(id) ON DELETE CASCADE,
    user_id BIGINT REFERENCES users(id) ON DELETE CASCADE,
    order_id BIGINT REFERENCES orders(id) ON DELETE CASCADE,

    -- Usage details
    discount_applied DECIMAL(10,2) NOT NULL,
    order_amount DECIMAL(10,2) NOT NULL,

    -- Metadata
    used_at TIMESTAMP DEFAULT NOW(),

    -- Indexes
    INDEX idx_promo_code_uses_promo (promo_code_id),
    INDEX idx_promo_code_uses_user (user_id),
    INDEX idx_promo_code_uses_order (order_id),
    INDEX idx_promo_code_uses_date (used_at),
    UNIQUE(promo_code_id, user_id, order_id)
);

-- Cashback settings
CREATE TABLE cashback_settings (
    id BIGSERIAL PRIMARY KEY,
    restaurant_branch_id BIGINT REFERENCES restaurant_branches(id) ON DELETE CASCADE,

    -- Cashback rules
    cashback_percent DECIMAL(5,2) NOT NULL DEFAULT 0,
    min_order_amount DECIMAL(10,2) DEFAULT 0,
    max_cashback_per_order DECIMAL(10,2),

    -- Validity
    valid_from TIMESTAMP DEFAULT NOW(),
    valid_to TIMESTAMP,

    -- Restrictions
    applicable_order_types JSONB DEFAULT '["delivery", "pickup"]',
    applicable_categories JSONB DEFAULT '[]',
    applicable_products JSONB DEFAULT '[]',

    -- Status
    is_active BOOLEAN DEFAULT TRUE,

    -- Metadata
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW(),

    -- Indexes
    INDEX idx_cashback_settings_branch (restaurant_branch_id),
    INDEX idx_cashback_settings_active (is_active),
    INDEX idx_cashback_settings_validity (valid_from, valid_to)
);
3.1.6. Promotions & Marketing
sql
-- Promotions management
CREATE TABLE promotions (
    id BIGSERIAL PRIMARY KEY,
    title VARCHAR(255) NOT NULL,
    description TEXT,
    short_description VARCHAR(500),

    -- Media
    image_url TEXT,
    thumbnail_url TEXT,
    banner_url TEXT,

    -- Promotion type
    promotion_type VARCHAR(50) NOT NULL CHECK (
        promotion_type IN ('discount', 'gift', 'free_delivery',
                          'combo', 'flash_sale', 'seasonal')
    ),

    -- Conditions and rewards
    conditions JSONB DEFAULT '{}',
    rewards JSONB DEFAULT '{}',

    -- Display settings
    display_order INT DEFAULT 0,
    display_location JSONB DEFAULT '["homepage", "catalog", "product"]',
    badge_text VARCHAR(50),
    badge_color VARCHAR(7),

    -- Targeting
    target_audience JSONB DEFAULT '{}',
    target_restaurants JSONB DEFAULT '{}',
    target_categories JSONB DEFAULT '{}',
    target_products JSONB DEFAULT '{}',

    -- Schedule
    valid_from TIMESTAMP DEFAULT NOW(),
    valid_to TIMESTAMP,
    show_before_start BOOLEAN DEFAULT FALSE,
    show_after_end BOOLEAN DEFAULT FALSE,

    -- Status
    is_active BOOLEAN DEFAULT TRUE,
    is_featured BOOLEAN DEFAULT FALSE,

    -- Metadata
    created_by BIGINT REFERENCES users(id),
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW(),

    -- Indexes
    INDEX idx_promotions_type (promotion_type),
    INDEX idx_promotions_active (is_active),
    INDEX idx_promotions_featured (is_featured),
    INDEX idx_promotions_validity (valid_from, valid_to),
    INDEX idx_promotions_order (display_order)
);

-- Newsletter campaigns
CREATE TABLE newsletters (
    id BIGSERIAL PRIMARY KEY,
    campaign_name VARCHAR(255) NOT NULL,
    subject VARCHAR(255),
    content TEXT NOT NULL,
    content_html TEXT,

    -- Campaign type
    campaign_type VARCHAR(50) NOT NULL CHECK (
        campaign_type IN ('promotional', 'informational', 'transactional',
                         'birthday', 'anniversary', 'abandoned_cart')
    ),

    -- Delivery settings
    delivery_method VARCHAR(50) NOT NULL CHECK (
        delivery_method IN ('telegram', 'email', 'sms', 'push')
    ),

    -- Targeting
    target_segment JSONB NOT NULL DEFAULT '{}',
    user_ids_include JSONB DEFAULT '[]',
    user_ids_exclude JSONB DEFAULT '[]',

    -- Scheduling
    scheduled_for TIMESTAMP,
    sent_at TIMESTAMP,

    -- Statistics
    total_recipients INT DEFAULT 0,
    sent_count INT DEFAULT 0,
    delivered_count INT DEFAULT 0,
    opened_count INT DEFAULT 0,
    clicked_count INT DEFAULT 0,
    unsubscribed_count INT DEFAULT 0,
    bounce_count INT DEFAULT 0,

    -- Status
    status VARCHAR(50) DEFAULT 'draft' CHECK (
        status IN ('draft', 'scheduled', 'sending', 'sent', 'cancelled', 'failed')
    ),

    -- Metadata
    created_by BIGINT REFERENCES users(id),
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW(),

    -- Indexes
    INDEX idx_newsletters_type (campaign_type),
    INDEX idx_newsletters_status (status),
    INDEX idx_newsletters_scheduled (scheduled_for),
    INDEX idx_newsletters_created (created_at)
);

-- Newsletter recipients
CREATE TABLE newsletter_recipients (
    id BIGSERIAL PRIMARY KEY,
    newsletter_id BIGINT REFERENCES newsletters(id) ON DELETE CASCADE,
    user_id BIGINT REFERENCES users(id) ON DELETE CASCADE,

    -- Delivery status
    status VARCHAR(50) DEFAULT 'pending' CHECK (
        status IN ('pending', 'sent', 'delivered', 'opened',
                  'clicked', 'failed', 'bounced', 'unsubscribed')
    ),

    -- Delivery info
    sent_at TIMESTAMP,
    delivered_at TIMESTAMP,
    opened_at TIMESTAMP,
    clicked_at TIMESTAMP,
    failed_at TIMESTAMP,
    failure_reason TEXT,

    -- Tracking
    open_count INT DEFAULT 0,
    click_count INT DEFAULT 0,
    tracking_token VARCHAR(100) UNIQUE,

    -- Metadata
    created_at TIMESTAMP DEFAULT NOW(),

    -- Indexes
    INDEX idx_newsletter_recipients_newsletter (newsletter_id),
    INDEX idx_newsletter_recipients_user (user_id),
    INDEX idx_newsletter_recipients_status (status),
    INDEX idx_newsletter_recipients_sent (sent_at),
    UNIQUE(newsletter_id, user_id)
);
3.1.7. Analytics & Audit System
sql
-- User events tracking
CREATE TABLE user_events (
    id BIGSERIAL PRIMARY KEY,
    user_id BIGINT REFERENCES users(id) ON DELETE SET NULL,
    session_id VARCHAR(100),

    -- Event details
    event_type VARCHAR(100) NOT NULL,
    event_category VARCHAR(100),
    event_action VARCHAR(100),
    event_label VARCHAR(255),
    event_value DECIMAL(10,2),

    -- Event data
    event_data JSONB,
    page_url VARCHAR(500),
    page_title VARCHAR(255),
    referrer_url VARCHAR(500),

    -- Device and location
    device_type VARCHAR(50),
    device_platform VARCHAR(50),
    browser VARCHAR(100),
    browser_version VARCHAR(50),
    os VARCHAR(100),
    os_version VARCHAR(50),
    screen_resolution VARCHAR(50),
    language VARCHAR(10),

    -- Location
    ip_address INET,
    country VARCHAR(100),
    city VARCHAR(100),
    region VARCHAR(100),
    timezone VARCHAR(50),

    -- Metadata
    created_at TIMESTAMP DEFAULT NOW(),

    -- Indexes
    INDEX idx_user_events_user (user_id),
    INDEX idx_user_events_type (event_type),
    INDEX idx_user_events_category (event_category),
    INDEX idx_user_events_created (created_at),
    INDEX idx_user_events_session (session_id),
    INDEX idx_user_events_page (page_url)
);

-- Admin audit logs
CREATE TABLE admin_audit_logs (
    id BIGSERIAL PRIMARY KEY,
    admin_id BIGINT REFERENCES users(id) ON DELETE SET NULL,

    -- Action details
    action_type VARCHAR(100) NOT NULL,
    action VARCHAR(255) NOT NULL,
    entity_type VARCHAR(100),
    entity_id BIGINT,
    entity_name VARCHAR(255),

    -- Changes
    old_values JSONB,
    new_values JSONB,
    changed_fields TEXT[],

    -- Context
    ip_address INET,
    user_agent TEXT,
    request_method VARCHAR(10),
    request_url VARCHAR(500),
    request_body JSONB,

    -- Metadata
    created_at TIMESTAMP DEFAULT NOW(),

    -- Indexes
    INDEX idx_admin_audit_logs_admin (admin_id),
    INDEX idx_admin_audit_logs_action (action_type),
    INDEX idx_admin_audit_logs_entity (entity_type, entity_id),
    INDEX idx_admin_audit_logs_created (created_at)
);

-- Payment logs
CREATE TABLE payment_logs (
    id BIGSERIAL PRIMARY KEY,
    order_id BIGINT REFERENCES orders(id) ON DELETE SET NULL,

    -- Payment details
    payment_provider VARCHAR(100) NOT NULL,
    transaction_id VARCHAR(255),
    external_transaction_id VARCHAR(255),
    payment_method VARCHAR(50),

    -- Amounts
    amount DECIMAL(10,2) NOT NULL,
    currency VARCHAR(3) DEFAULT 'RUB',
    fee_amount DECIMAL(10,2),
    net_amount DECIMAL(10,2),

    -- Status
    status VARCHAR(50) NOT NULL,
    status_reason TEXT,

    -- Request/response
    request_data JSONB,
    response_data JSONB,
    callback_data JSONB,

    -- Error info
    error_code VARCHAR(100),
    error_message TEXT,
    is_test BOOLEAN DEFAULT FALSE,

    -- Metadata
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW(),

    -- Indexes
    INDEX idx_payment_logs_order (order_id),
    INDEX idx_payment_logs_provider (payment_provider),
    INDEX idx_payment_logs_status (status),
    INDEX idx_payment_logs_created (created_at),
    INDEX idx_payment_logs_transaction (transaction_id)
);

-- System performance metrics
CREATE TABLE system_metrics (
    id BIGSERIAL PRIMARY KEY,
    metric_name VARCHAR(100) NOT NULL,
    metric_value DECIMAL(15,4) NOT NULL,
    metric_unit VARCHAR(50),

    -- Dimensions
    dimension_1_name VARCHAR(100),
    dimension_1_value VARCHAR(255),
    dimension_2_name VARCHAR(100),
    dimension_2_value VARCHAR(255),
    dimension_3_name VARCHAR(100),
    dimension_3_value VARCHAR(255),

    -- Metadata
    recorded_at TIMESTAMP DEFAULT NOW(),

    -- Indexes
    INDEX idx_system_metrics_name (metric_name),
    INDEX idx_system_metrics_recorded (recorded_at),
    INDEX idx_system_metrics_dimensions (dimension_1_name, dimension_1_value)
);

-- Business KPIs
CREATE TABLE business_kpis (
    id BIGSERIAL PRIMARY KEY,
    kpi_date DATE NOT NULL,
    kpi_period VARCHAR(20) CHECK (kpi_period IN ('daily', 'weekly', 'monthly', 'quarterly', 'yearly')),

    -- Order metrics
    total_orders INT DEFAULT 0,
    total_revenue DECIMAL(15,2) DEFAULT 0,
    average_order_value DECIMAL(10,2) DEFAULT 0,
    order_conversion_rate DECIMAL(5,2) DEFAULT 0,

    -- Customer metrics
    new_customers INT DEFAULT 0,
    returning_customers INT DEFAULT 0,
    total_customers INT DEFAULT 0,
    customer_acquisition_cost DECIMAL(10,2) DEFAULT 0,
    customer_lifetime_value DECIMAL(10,2) DEFAULT 0,

    -- Product metrics
    top_products JSONB DEFAULT '[]',
    top_categories JSONB DEFAULT '[]',

    -- Delivery metrics
    delivery_orders INT DEFAULT 0,
    pickup_orders INT DEFAULT 0,
    average_delivery_time_minutes INT DEFAULT 0,
    on_time_delivery_rate DECIMAL(5,2) DEFAULT 0,

    -- Payment metrics
    cash_orders INT DEFAULT 0,
    card_orders INT DEFAULT 0,
    online_payment_orders INT DEFAULT 0,

    -- Metadata
    calculated_at TIMESTAMP DEFAULT NOW(),

    -- Constraints
    UNIQUE(kpi_date, kpi_period),

    -- Indexes
    INDEX idx_business_kpis_date (kpi_date),
    INDEX idx_business_kpis_period (kpi_period)
);
3.1.8. Settings & Configuration
sql
-- Global system settings
CREATE TABLE system_settings (
    id BIGSERIAL PRIMARY KEY,
    setting_key VARCHAR(100) UNIQUE NOT NULL,
    setting_value TEXT,
    setting_type VARCHAR(50) DEFAULT 'string' CHECK (
        setting_type IN ('string', 'integer', 'decimal', 'boolean', 'json', 'array')
    ),
    category VARCHAR(100) DEFAULT 'general',
    description TEXT,
    is_public BOOLEAN DEFAULT FALSE,
    is_encrypted BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW(),

    INDEX idx_system_settings_key (setting_key),
    INDEX idx_system_settings_category (category)
);

-- Restaurant-specific settings
CREATE TABLE restaurant_settings (
    id BIGSERIAL PRIMARY KEY,
    restaurant_id BIGINT REFERENCES restaurants(id) ON DELETE CASCADE,
    setting_key VARCHAR(100) NOT NULL,
    setting_value TEXT,
    setting_type VARCHAR(50) DEFAULT 'string',
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW(),

    UNIQUE(restaurant_id, setting_key),

    INDEX idx_restaurant_settings_restaurant (restaurant_id),
    INDEX idx_restaurant_settings_key (setting_key)
);

-- Branch-specific settings
CREATE TABLE branch_settings (
    id BIGSERIAL PRIMARY KEY,
    branch_id BIGINT REFERENCES restaurant_branches(id) ON DELETE CASCADE,
    setting_key VARCHAR(100) NOT NULL,
    setting_value TEXT,
    setting_type VARCHAR(50) DEFAULT 'string',
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW(),

    UNIQUE(branch_id, setting_key),

    INDEX idx_branch_settings_branch (branch_id),
    INDEX idx_branch_settings_key (setting_key)
);
