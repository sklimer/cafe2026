
5.1.2. –†–µ—Å—Ç–æ—Ä–∞–Ω—ã –∏ —Ñ–∏–ª–∏–∞–ª—ã
python
# api/v1/restaurants/
router.register('restaurants', RestaurantViewSet)
router.register('branches', RestaurantBranchViewSet)

class RestaurantViewSet(viewsets.ReadOnlyModelViewSet):
    """
    –†–µ—Å—Ç–æ—Ä–∞–Ω—ã (—Ç–æ–ª—å–∫–æ —á—Ç–µ–Ω–∏–µ –¥–ª—è –∫–ª–∏–µ–Ω—Ç–æ–≤)
    """
    queryset = Restaurant.objects.filter(is_active=True)
    serializer_class = RestaurantSerializer
    filter_backends = [filters.SearchFilter, filters.OrderingFilter]
    search_fields = ['name', 'description', 'slug']
    ordering_fields = ['name', 'created_at']

    @action(detail=True, methods=['GET'])
    def branches(self, request, pk=None):
        """
        –§–∏–ª–∏–∞–ª—ã —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞
        GET /api/v1/restaurants/{id}/branches/
        """
        pass

    @action(detail=True, methods=['GET'])
    def menu(self, request, pk=None):
        """
        –ú–µ–Ω—é —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞ (–∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –∏ —Ç–æ–≤–∞—Ä—ã)
        GET /api/v1/restaurants/{id}/menu/
        """
        pass

class RestaurantBranchViewSet(viewsets.ReadOnlyModelViewSet):
    """
    –§–∏–ª–∏–∞–ª—ã —Ä–µ—Å—Ç–æ—Ä–∞–Ω–æ–≤
    """
    queryset = RestaurantBranch.objects.filter(is_active=True)
    serializer_class = RestaurantBranchSerializer
    filter_backends = [filters.SearchFilter, DjangoFilterBackend]
    search_fields = ['name', 'address', 'city']
    filterset_fields = ['restaurant', 'city', 'is_accepting_orders']

    @action(detail=True, methods=['GET'])
    def availability(self, request, pk=None):
        """
        –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –∑–∞–∫–∞–∑–∞ –≤ —Ñ–∏–ª–∏–∞–ª–µ
        GET /api/v1/branches/{id}/availability/
        –ü–∞—Ä–∞–º–µ—Ç—Ä—ã:
        - order_type: delivery/pickup
        - delivery_address (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
        """
        pass

    @action(detail=True, methods=['GET'])
    def delivery_zones(self, request, pk=None):
        """
        –ó–æ–Ω—ã –¥–æ—Å—Ç–∞–≤–∫–∏ —Ñ–∏–ª–∏–∞–ª–∞
        GET /api/v1/branches/{id}/delivery_zones/
        """
        pass

    @action(detail=True, methods=['GET'])
    def time_slots(self, request, pk=None):
        """
        –î–æ—Å—Ç—É–ø–Ω—ã–µ —Å–ª–æ—Ç—ã –≤—Ä–µ–º–µ–Ω–∏
        GET /api/v1/branches/{id}/time_slots/
        –ü–∞—Ä–∞–º–µ—Ç—Ä—ã:
        - date: YYYY-MM-DD
        - slot_type: delivery/pickup
        """
        pass
5.1.3. –ö–∞—Ç–∞–ª–æ–≥ —Ç–æ–≤–∞—Ä–æ–≤
python
# api/v1/catalog/
router.register('categories', CategoryViewSet)
router.register('products', ProductViewSet)
router.register('tags', TagViewSet)

class CategoryViewSet(viewsets.ReadOnlyModelViewSet):
    """
    –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ —Ç–æ–≤–∞—Ä–æ–≤
    """
    queryset = Category.objects.filter(is_active=True, is_visible=True)
    serializer_class = CategorySerializer
    filter_backends = [DjangoFilterBackend, filters.OrderingFilter]
    filterset_fields = ['restaurant', 'parent']
    ordering_fields = ['display_order', 'name']

    @action(detail=True, methods=['GET'])
    def products(self, request, pk=None):
        """
        –¢–æ–≤–∞—Ä—ã –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
        GET /api/v1/categories/{id}/products/
        """
        pass

class ProductViewSet(viewsets.ReadOnlyModelViewSet):
    """
    –¢–æ–≤–∞—Ä—ã
    """
    queryset = Product.objects.filter(is_available=True)
    serializer_class = ProductSerializer
    filter_backends = [filters.SearchFilter, DjangoFilterBackend, filters.OrderingFilter]
    search_fields = ['name', 'description', 'short_description']
    filterset_fields = ['restaurant', 'category', 'is_popular', 'is_new',
                       'is_recommended', 'is_vegetarian', 'is_vegan', 'is_gluten_free']
    ordering_fields = ['display_order', 'price', 'created_at', 'popularity']

    @action(detail=True, methods=['GET'])
    def options(self, request, pk=None):
        """
        –î–æ—Å—Ç—É–ø–Ω—ã–µ –æ–ø—Ü–∏–∏ —Ç–æ–≤–∞—Ä–∞
        GET /api/v1/products/{id}/options/
        """
        pass

    @action(detail=False, methods=['GET'])
    def search(self, request):
        """
        –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π –ø–æ–∏—Å–∫ —Ç–æ–≤–∞—Ä–æ–≤
        GET /api/v1/products/search/
        –ü–∞—Ä–∞–º–µ—Ç—Ä—ã:
        - q: –ø–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å
        - category: id –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
        - tags: —Å–ø–∏—Å–æ–∫ —Ç–µ–≥–æ–≤
        - min_price, max_price
        - sort: price_asc, price_desc, popular, new
        """
        pass

class TagViewSet(viewsets.ReadOnlyModelViewSet):
    """
    –¢–µ–≥–∏ —Ç–æ–≤–∞—Ä–æ–≤
    """
    queryset = Tag.objects.filter(is_active=True)
    serializer_class = TagSerializer
    filter_backends = [DjangoFilterBackend]
    filterset_fields = ['restaurant']
5.1.4. –ö–æ—Ä–∑–∏–Ω–∞
python
# api/v1/cart/
router.register('cart', CartViewSet, basename='cart')

class CartViewSet(viewsets.ViewSet):
    """
    –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ—Ä–∑–∏–Ω–æ–π
    """

    def list(self, request):
        """
        –ü–æ–ª—É—á–µ–Ω–∏–µ –∫–æ—Ä–∑–∏–Ω—ã
        GET /api/v1/cart/
        """
        pass

    @action(detail=False, methods=['POST'])
    def add(self, request):
        """
        –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞ –≤ –∫–æ—Ä–∑–∏–Ω—É
        POST /api/v1/cart/add/
        {
            "product_id": 1,
            "quantity": 2,
            "selected_options": [
                {"option_id": 1, "value_ids": [1, 2]}
            ]
        }
        """
        pass

    @action(detail=False, methods=['PUT'])
    def update(self, request):
        """
        –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞ –≤ –∫–æ—Ä–∑–∏–Ω–µ
        PUT /api/v1/cart/update/
        {
            "item_id": 1,
            "quantity": 3
        }
        """
        pass

    @action(detail=False, methods=['DELETE'])
    def remove(self, request):
        """
        –£–¥–∞–ª–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞ –∏–∑ –∫–æ—Ä–∑–∏–Ω—ã
        DELETE /api/v1/cart/remove/
        {
            "item_id": 1
        }
        """
        pass

    @action(detail=False, methods=['POST'])
    def clear(self, request):
        """
        –û—á–∏—Å—Ç–∫–∞ –∫–æ—Ä–∑–∏–Ω—ã
        POST /api/v1/cart/clear/
        """
        pass
5.1.5. –ó–∞–∫–∞–∑—ã
python
# api/v1/orders/
router.register('orders', OrderViewSet, basename='order')

class OrderViewSet(viewsets.ModelViewSet):
    """
    –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞–º–∏
    """
    serializer_class = OrderSerializer
    permission_classes = [IsAuthenticated]

    def get_queryset(self):
        return Order.objects.filter(user=self.request.user)

    def create(self, request):
        """
        –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞
        POST /api/v1/orders/
        {
            "branch_id": 1,
            "order_type": "delivery",
            "delivery_address_id": 1,
            "preferred_delivery_time": "2024-01-20T18:00:00",
            "items": [
                {
                    "product_id": 1,
                    "quantity": 2,
                    "selected_options": [...]
                }
            ],
            "promo_code": "SUMMER2024",
            "bonus_used": 100,
            "payment_method": "card_online",
            "customer_comment": "–ü–æ–∑–≤–æ–Ω–∏—Ç—å –∑–∞ —á–∞—Å"
        }
        """
        pass

    @action(detail=True, methods=['POST'])
    def cancel(self, request, pk=None):
        """
        –û—Ç–º–µ–Ω–∞ –∑–∞–∫–∞–∑–∞
        POST /api/v1/orders/{id}/cancel/
        """
        pass

    @action(detail=True, methods=['GET'])
    def status(self, request, pk=None):
        """
        –ü–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–∫–∞–∑–∞
        GET /api/v1/orders/{id}/status/
        """
        pass

    @action(detail=True, methods=['GET'])
    def track(self, request, pk=None):
        """
        –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞ (–¥–ª—è –¥–æ—Å—Ç–∞–≤–∫–∏)
        GET /api/v1/orders/{id}/track/
        """
        pass
5.1.6. –ê–¥—Ä–µ—Å–∞ –¥–æ—Å—Ç–∞–≤–∫–∏
python
# api/v1/addresses/
router.register('addresses', UserAddressViewSet, basename='address')

class UserAddressViewSet(viewsets.ModelViewSet):
    """
    –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∞–¥—Ä–µ—Å–∞–º–∏ –¥–æ—Å—Ç–∞–≤–∫–∏
    """
    serializer_class = UserAddressSerializer
    permission_classes = [IsAuthenticated]

    def get_queryset(self):
        return UserAddress.objects.filter(user=self.request.user)

    @action(detail=False, methods=['POST'])
    def geocode(self, request):
        """
        –ì–µ–æ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ –∞–¥—Ä–µ—Å–∞
        POST /api/v1/addresses/geocode/
        {
            "address": "—É–ª. –ü—Ä–∏–º–µ—Ä–Ω–∞—è, 10"
        }
        """
        pass

    @action(detail=False, methods=['GET'])
    def suggestions(self, request):
        """
        –ü–æ–¥—Å–∫–∞–∑–∫–∏ –∞–¥—Ä–µ—Å–æ–≤
        GET /api/v1/addresses/suggestions/
        –ü–∞—Ä–∞–º–µ—Ç—Ä—ã:
        - query: —á–∞—Å—Ç—å –∞–¥—Ä–µ—Å–∞
        """
        pass
5.1.7. –ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
python
# api/v1/profile/
router.register('profile', ProfileViewSet, basename='profile')

class ProfileViewSet(viewsets.ViewSet):
    """
    –ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    """
    permission_classes = [IsAuthenticated]

    def list(self, request):
        """
        –ü–æ–ª—É—á–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è
        GET /api/v1/profile/
        """
        pass

    @action(detail=False, methods=['PUT'])
    def update(self, request):
        """
        –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è
        PUT /api/v1/profile/
        """
        pass

    @action(detail=False, methods=['GET'])
    def orders(self, request):
        """
        –ò—Å—Ç–æ—Ä–∏—è –∑–∞–∫–∞–∑–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        GET /api/v1/profile/orders/
        """
        pass

    @action(detail=False, methods=['GET'])
    def bonus(self, request):
        """
        –ë–æ–Ω—É—Å–Ω—ã–π –±–∞–ª–∞–Ω—Å –∏ –∏—Å—Ç–æ—Ä–∏—è
        GET /api/v1/profile/bonus/
        """
        pass

    @action(detail=False, methods=['GET'])
    def referral(self, request):
        """
        –†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
        GET /api/v1/profile/referral/
        """
        pass
5.1.8. –ë–æ–Ω—É—Å—ã –∏ –ø—Ä–æ–º–æ–∫–æ–¥—ã
python
# api/v1/bonus/
router.register('bonus', BonusViewSet, basename='bonus')
router.register('promo', PromoCodeViewSet, basename='promo')

class BonusViewSet(viewsets.ViewSet):
    """
    –ë–æ–Ω—É—Å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞
    """
    permission_classes = [IsAuthenticated]

    @action(detail=False, methods=['GET'])
    def balance(self, request):
        """
        –ë–æ–Ω—É—Å–Ω—ã–π –±–∞–ª–∞–Ω—Å
        GET /api/v1/bonus/balance/
        """
        pass

    @action(detail=False, methods=['GET'])
    def transactions(self, request):
        """
        –ò—Å—Ç–æ—Ä–∏—è –±–æ–Ω—É—Å–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
        GET /api/v1/bonus/transactions/
        """
        pass

    @action(detail=False, methods=['GET'])
    def rules(self, request):
        """
        –ê–∫—Ç–∏–≤–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è –±–æ–Ω—É—Å–æ–≤
        GET /api/v1/bonus/rules/
        """
        pass

class PromoCodeViewSet(viewsets.ViewSet):
    """
    –ü—Ä–æ–º–æ–∫–æ–¥—ã
    """

    @action(detail=False, methods=['POST'])
    def validate(self, request):
        """
        –í–∞–ª–∏–¥–∞—Ü–∏—è –ø—Ä–æ–º–æ–∫–æ–¥–∞
        POST /api/v1/promo/validate/
        {
            "code": "SUMMER2024",
            "order_amount": 1500,
            "branch_id": 1
        }
        """
        pass

    @action(detail=False, methods=['GET'])
    def active(self, request):
        """
        –ê–∫—Ç–∏–≤–Ω—ã–µ –ø—Ä–æ–º–æ–∫–æ–¥—ã
        GET /api/v1/promo/active/
        """
        pass
5.1.9. –ü–ª–∞—Ç–µ–∂–∏
python
# api/v1/payments/
router.register('payments', PaymentViewSet, basename='payment')

class PaymentViewSet(viewsets.ViewSet):
    """
    –ü–ª–∞—Ç–µ–∂–∏
    """
    permission_classes = [IsAuthenticated]

    @action(detail=False, methods=['POST'])
    def create(self, request):
        """
        –°–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞
        POST /api/v1/payments/create/
        {
            "order_id": 1,
            "method": "card_online",
            "return_url": "https://..."
        }
        """
        pass

    @action(detail=False, methods=['GET'])
    def status(self, request):
        """
        –°—Ç–∞—Ç—É—Å –ø–ª–∞—Ç–µ–∂–∞
        GET /api/v1/payments/status/
        –ü–∞—Ä–∞–º–µ—Ç—Ä—ã:
        - order_id: ID –∑–∞–∫–∞–∑–∞
        - payment_id: ID –ø–ª–∞—Ç–µ–∂–∞
        """
        pass

    @action(detail=False, methods=['POST'], permission_classes=[AllowAny])
    def webhook(self, request):
        """
        Webhook –æ—Ç –ø–ª–∞—Ç–µ–∂–Ω–æ–≥–æ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞
        POST /api/v1/payments/webhook/
        """
        pass
5.1.10. –ê–∫—Ü–∏–∏ –∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
python
# api/v1/promotions/
router.register('promotions', PromotionViewSet, basename='promotion')
router.register('notifications', NotificationViewSet, basename='notification')

class PromotionViewSet(viewsets.ReadOnlyModelViewSet):
    """
    –ê–∫—Ü–∏–∏ –∏ –ø—Ä–æ–º–æ–∞–∫—Ü–∏–∏
    """
    queryset = Promotion.objects.filter(
        is_active=True,
        valid_from__lte=timezone.now(),
        valid_to__gte=timezone.now()
    )
    serializer_class = PromotionSerializer
    filter_backends = [DjangoFilterBackend]
    filterset_fields = ['promotion_type', 'target_restaurants']

class NotificationViewSet(viewsets.ViewSet):
    """
    –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
    """
    permission_classes = [IsAuthenticated]

    def list(self, request):
        """
        –°–ø–∏—Å–æ–∫ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
        GET /api/v1/notifications/
        """
        pass

    @action(detail=True, methods=['POST'])
    def read(self, request, pk=None):
        """
        –û—Ç–º–µ—Ç–∏—Ç—å –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω–æ–µ
        POST /api/v1/notifications/{id}/read/
        """
        pass

    @action(detail=False, methods=['POST'])
    def read_all(self, request):
        """
        –û—Ç–º–µ—Ç–∏—Ç—å –≤—Å–µ –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ
        POST /api/v1/notifications/read_all/
        """
        pass
5.2. –°–µ—Ä–∏–∞–ª–∏–∑–∞—Ç–æ—Ä—ã
python
class RestaurantSerializer(serializers.ModelSerializer):
    branches_count = serializers.SerializerMethodField()

    class Meta:
        model = Restaurant
        fields = ['id', 'name', 'slug', 'description', 'logo_url',
                 'cover_url', 'contact_phone', 'branches_count']

    def get_branches_count(self, obj):
        return obj.branches.filter(is_active=True).count()

class RestaurantBranchSerializer(serializers.ModelSerializer):
    restaurant_name = serializers.CharField(source='restaurant.name')
    delivery_info = serializers.SerializerMethodField()
    availability = serializers.SerializerMethodField()

    class Meta:
        model = RestaurantBranch
        fields = ['id', 'name', 'restaurant', 'restaurant_name', 'address',
                 'city', 'latitude', 'longitude', 'phone', 'business_hours',
                 'min_order_amount', 'delivery_fee', 'free_delivery_threshold',
                 'delivery_radius_meters', 'delivery_info', 'availability',
                 'accepted_payment_methods', 'is_accepting_orders']

    def get_delivery_info(self, obj):
        return {
            'fee': obj.delivery_fee,
            'free_threshold': obj.free_delivery_threshold,
            'radius': obj.delivery_radius_meters
        }

    def get_availability(self, obj):
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –Ω–∞ —Ç–µ–∫—É—â–∏–π –º–æ–º–µ–Ω—Ç
        return {
            'is_open': obj.is_open_now(),
            'next_open': obj.get_next_opening_time(),
            'can_accept_orders': obj.is_accepting_orders
        }

class ProductSerializer(serializers.ModelSerializer):
    category_name = serializers.CharField(source='category.name', allow_null=True)
    restaurant_name = serializers.CharField(source='restaurant.name')
    tags = TagSerializer(many=True, read_only=True)
    options = serializers.SerializerMethodField()
    in_stock = serializers.SerializerMethodField()

    class Meta:
        model = Product
        fields = ['id', 'name', 'description', 'short_description', 'price',
                 'old_price', 'category', 'category_name', 'restaurant',
                 'restaurant_name', 'weight_grams', 'calories', 'main_image_url',
                 'image_urls', 'is_popular', 'is_new', 'is_recommended',
                 'is_vegetarian', 'is_vegan', 'is_gluten_free', 'tags',
                 'options', 'in_stock', 'cooking_time_minutes']

    def get_options(self, obj):
        # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –¥–æ—Å—Ç—É–ø–Ω—ã–µ –æ–ø—Ü–∏–∏ —Ç–æ–≤–∞—Ä–∞
        return ProductOptionSerializer(
            obj.available_options.all(),
            many=True,
            context=self.context
        ).data

    def get_in_stock(self, obj):
        if obj.is_unlimited_stock:
            return True
        if obj.stock_quantity is None:
            return obj.is_available
        return obj.stock_quantity > 0

class ProductOptionSerializer(serializers.ModelSerializer):
    values = OptionValueSerializer(many=True, source='available_values')

    class Meta:
        model = ProductOption
        fields = ['id', 'name', 'description', 'option_type', 'is_required',
                 'min_selection', 'max_selection', 'values']

class CartItemSerializer(serializers.Serializer):
    product_id = serializers.IntegerField()
    quantity = serializers.IntegerField(min_value=1)
    selected_options = serializers.JSONField(required=False, default=list)

    def validate(self, data):
        product_id = data['product_id']
        try:
            product = Product.objects.get(id=product_id, is_available=True)
        except Product.DoesNotExist:
            raise serializers.ValidationError("–¢–æ–≤–∞—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω")

        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–ø—Ü–∏–π
        selected_options = data.get('selected_options', [])
        if selected_options:
            self.validate_options(product, selected_options)

        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –Ω–∞ —Å–∫–ª–∞–¥–µ
        if not product.is_unlimited_stock and product.stock_quantity is not None:
            if product.stock_quantity < data['quantity']:
                raise serializers.ValidationError(
                    f"–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Ç–æ–≤–∞—Ä–∞ –Ω–∞ —Å–∫–ª–∞–¥–µ. –î–æ—Å—Ç—É–ø–Ω–æ: {product.stock_quantity}"
                )

        return data

    def validate_options(self, product, selected_options):
        for option_data in selected_options:
            option_id = option_data.get('option_id')
            value_ids = option_data.get('value_ids', [])

            try:
                option = ProductOption.objects.get(
                    id=option_id,
                    product_available_options__product=product
                )
            except ProductOption.DoesNotExist:
                raise serializers.ValidationError(
                    f"–û–ø—Ü–∏—è {option_id} –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ –¥–ª—è —ç—Ç–æ–≥–æ —Ç–æ–≤–∞—Ä–∞"
                )

            # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–Ω–∞—á–µ–Ω–∏–π –æ–ø—Ü–∏–π
            valid_values = option.values.filter(
                id__in=value_ids,
                is_available=True
            )
            if len(valid_values) != len(value_ids):
                raise serializers.ValidationError(
                    f"–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –¥–ª—è –æ–ø—Ü–∏–∏ {option.name}"
                )

            # –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–≥–æ/–º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞
            if len(value_ids) < option.min_selection:
                raise serializers.ValidationError(
                    f"–î–ª—è –æ–ø—Ü–∏–∏ {option.name} –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –≤—ã–±—Ä–∞—Ç—å –º–∏–Ω–∏–º—É–º {option.min_selection} –∑–Ω–∞—á–µ–Ω–∏–π"
                )
            if len(value_ids) > option.max_selection:
                raise serializers.ValidationError(
                    f"–î–ª—è –æ–ø—Ü–∏–∏ {option.name} –º–æ–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å –º–∞–∫—Å–∏–º—É–º {option.max_selection} –∑–Ω–∞—á–µ–Ω–∏–π"
                )

class OrderSerializer(serializers.ModelSerializer):
    items = OrderItemSerializer(many=True, write_only=True)
    delivery_address = UserAddressSerializer(read_only=True)
    restaurant_branch = RestaurantBranchSerializer(read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)
    payment_status_display = serializers.CharField(source='get_payment_status_display', read_only=True)
    estimated_delivery_time = serializers.SerializerMethodField()

    class Meta:
        model = Order
        fields = ['id', 'order_number', 'user', 'restaurant_branch', 'order_type',
                 'status', 'status_display', 'delivery_address', 'subtotal',
                 'delivery_fee', 'discount_amount', 'bonus_used', 'total_amount',
                 'payment_method', 'payment_status', 'payment_status_display',
                 'customer_comment', 'items', 'estimated_delivery_time',
                 'created_at', 'updated_at']
        read_only_fields = ['order_number', 'status', 'payment_status',
                           'subtotal', 'delivery_fee', 'total_amount',
                           'created_at', 'updated_at']

    def get_estimated_delivery_time(self, obj):
        if obj.order_type == 'delivery':
            return obj.estimated_delivery_time
        return obj.estimated_preparation_time

    def validate(self, data):
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–π —Å—É–º–º—ã –∑–∞–∫–∞–∑–∞
        branch = data.get('restaurant_branch')
        if branch and data.get('subtotal', 0) < branch.min_order_amount:
            raise serializers.ValidationError(
                f"–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞ –∑–∞–∫–∞–∑–∞: {branch.min_order_amount} —Ä—É–±."
            )

        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—Ä–µ–º–µ–Ω–∏ —Ä–∞–±–æ—Ç—ã
        if not branch.is_accepting_orders_now():
            raise serializers.ValidationError(
                "–†–µ—Å—Ç–æ—Ä–∞–Ω –Ω–µ –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –∑–∞–∫–∞–∑—ã –≤ –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç"
            )

        return data

    def create(self, validated_data):
        items_data = validated_data.pop('items')

        # –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞
        order = Order.objects.create(**validated_data)

        # –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–æ–≤
        for item_data in items_data:
            OrderItem.objects.create(order=order, **item_data)

        # –†–∞—Å—á–µ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏
        order.calculate_totals()
        order.save()

        return order

class UserAddressSerializer(serializers.ModelSerializer):
    distance = serializers.SerializerMethodField()

    class Meta:
        model = UserAddress
        fields = ['id', 'user', 'alias', 'address', 'city', 'street', 'house',
                 'entrance', 'floor', 'apartment', 'intercom', 'comment',
                 'latitude', 'longitude', 'is_default', 'is_verified',
                 'distance', 'created_at']
        read_only_fields = ['user', 'created_at']

    def get_distance(self, obj):
        # –†–∞—Å—á–µ—Ç —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è –¥–æ –±–ª–∏–∂–∞–π—à–µ–≥–æ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞
        request = self.context.get('request')
        if request and 'branch_id' in request.query_params:
            try:
                branch = RestaurantBranch.objects.get(
                    id=request.query_params['branch_id']
                )
                return calculate_distance(
                    (obj.latitude, obj.longitude),
                    (branch.latitude, branch.longitude)
                )
            except:
                pass
        return None

    def validate(self, data):
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏
        if not data.get('latitude') or not data.get('longitude'):
            # –ü–æ–ø—ã—Ç–∫–∞ –≥–µ–æ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è
            address = data.get('address')
            if address:
                lat, lng = geocode_address(address)
                if lat and lng:
                    data['latitude'] = lat
                    data['longitude'] = lng

        return data

    def create(self, validated_data):
        # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–µ—Ä–≤–æ–≥–æ –∞–¥—Ä–µ—Å–∞ –∫–∞–∫ –∞–¥—Ä–µ—Å–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        user = self.context['request'].user
        if not user.addresses.exists():
            validated_data['is_default'] = True

        return super().create(validated_data)
5.3. Permissions (–†–∞–∑—Ä–µ—à–µ–Ω–∏—è)
python
class IsTelegramAuthenticated(permissions.BasePermission):
    """
    –†–∞–∑—Ä–µ—à–µ–Ω–∏–µ –¥–ª—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ Telegram
    """

    def has_permission(self, request, view):
        if not request.user.is_authenticated:
            return False

        # –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω —á–µ—Ä–µ–∑ Telegram
        return hasattr(request.user, 'telegram_id') and request.user.telegram_id

class IsOwnerOrAdmin(permissions.BasePermission):
    """
    –†–∞–∑—Ä–µ—à–µ–Ω–∏–µ –¥–ª—è –≤–ª–∞–¥–µ–ª—å—Ü–∞ –∏–ª–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
    """

    def has_object_permission(self, request, view, obj):
        if request.user.is_staff:
            return True

        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–ª–∞–¥–µ–Ω–∏—è –æ–±—ä–µ–∫—Ç–æ–º
        if hasattr(obj, 'user'):
            return obj.user == request.user
        elif hasattr(obj, 'customer'):
            return obj.customer == request.user
        elif hasattr(obj, 'owner'):
            return obj.owner == request.user

        return False

class IsRestaurantManager(permissions.BasePermission):
    """
    –†–∞–∑—Ä–µ—à–µ–Ω–∏–µ –¥–ª—è –º–µ–Ω–µ–¥–∂–µ—Ä–∞ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞
    """

    def has_permission(self, request, view):
        if not request.user.is_authenticated:
            return False

        # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–æ–ª–∏ –º–µ–Ω–µ–¥–∂–µ—Ä–∞
        if request.user.is_staff:
            return True

        # –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–µ–Ω–µ–¥–∂–µ—Ä –∫–∞–∫–æ–≥–æ-–ª–∏–±–æ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞
        return request.user.managed_restaurants.exists()

class CanModifyOrder(permissions.BasePermission):
    """
    –†–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞
    """

    def has_object_permission(self, request, view, obj):
        if request.user.is_staff:
            return True

        # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –∏–∑–º–µ–Ω—è—Ç—å —Ç–æ–ª—å–∫–æ —Å–≤–æ–∏ –∑–∞–∫–∞–∑—ã
        if obj.user != request.user:
            return False

        # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–∫–∞–∑–∞
        if view.action == 'cancel':
            return obj.status in ['pending', 'confirmed']

        return False

class BranchIsAcceptingOrders(permissions.BasePermission):
    """
    –†–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–∞ —Å–æ–∑–¥–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞ –≤ —Ñ–∏–ª–∏–∞–ª–µ
    """

    def has_permission(self, request, view):
        if view.action != 'create':
            return True

        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤ —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ç–æ—Ä–µ
        return True

    def has_object_permission(self, request, view, obj):
        return obj.is_accepting_orders
6. FRONTEND ARCHITECTURE (React + TypeScript)
6.1. –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞
text
src/
‚îú‚îÄ‚îÄ api/                          # API –∫–ª–∏–µ–Ω—Ç—ã
‚îÇ   ‚îú‚îÄ‚îÄ auth.ts
‚îÇ   ‚îú‚îÄ‚îÄ restaurants.ts
‚îÇ   ‚îú‚îÄ‚îÄ products.ts
‚îÇ   ‚îú‚îÄ‚îÄ cart.ts
‚îÇ   ‚îú‚îÄ‚îÄ orders.ts
‚îÇ   ‚îú‚îÄ‚îÄ addresses.ts
‚îÇ   ‚îú‚îÄ‚îÄ bonus.ts
‚îÇ   ‚îî‚îÄ‚îÄ payments.ts
‚îú‚îÄ‚îÄ components/                   # React –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
‚îÇ   ‚îú‚îÄ‚îÄ Layout/                   # –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –º–∞–∫–µ—Ç–∞
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Header.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Footer.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Sidebar.tsx
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ MainLayout.tsx
‚îÇ   ‚îú‚îÄ‚îÄ Auth/                     # –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ TelegramAuth.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ProtectedRoute.tsx
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ LoginRedirect.tsx
‚îÇ   ‚îú‚îÄ‚îÄ Restaurant/               # –†–µ—Å—Ç–æ—Ä–∞–Ω—ã
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ RestaurantCard.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ RestaurantList.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ BranchCard.tsx
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ BranchSelector.tsx
‚îÇ   ‚îú‚îÄ‚îÄ Catalog/                  # –ö–∞—Ç–∞–ª–æ–≥ —Ç–æ–≤–∞—Ä–æ–≤
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ CategoryCard.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ CategoryList.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ProductCard.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ProductList.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ProductDetail.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ProductOptions.tsx
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ProductSearch.tsx
‚îÇ   ‚îú‚îÄ‚îÄ Cart/                     # –ö–æ—Ä–∑–∏–Ω–∞
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ CartItem.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ CartList.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ CartTotal.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ CartWidget.tsx
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ CartModal.tsx
‚îÇ   ‚îú‚îÄ‚îÄ Order/                    # –ó–∞–∫–∞–∑—ã
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ OrderForm.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ OrderSummary.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ OrderStatus.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ OrderHistory.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ OrderTracking.tsx
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ PaymentMethods.tsx
‚îÇ   ‚îú‚îÄ‚îÄ Address/                  # –ê–¥—Ä–µ—Å–∞
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ AddressCard.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ AddressList.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ AddressForm.tsx
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ AddressSearch.tsx
‚îÇ   ‚îú‚îÄ‚îÄ Profile/                  # –ü—Ä–æ—Ñ–∏–ª—å
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ProfileInfo.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ProfileEdit.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ BonusBalance.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ReferralInfo.tsx
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ NotificationSettings.tsx
‚îÇ   ‚îú‚îÄ‚îÄ Promotions/               # –ê–∫—Ü–∏–∏
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ PromotionCard.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ PromotionList.tsx
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ PromoCodeInput.tsx
‚îÇ   ‚îú‚îÄ‚îÄ UI/                       # UI –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Button.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Input.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Select.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Modal.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Drawer.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Toast.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Loader.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Badge.tsx
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ Stepper.tsx
‚îÇ   ‚îî‚îÄ‚îÄ Shared/                   # –û–±—â–∏–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
‚îÇ       ‚îú‚îÄ‚îÄ ErrorBoundary.tsx
‚îÇ       ‚îú‚îÄ‚îÄ PageLoader.tsx
‚îÇ       ‚îú‚îÄ‚îÄ EmptyState.tsx
‚îÇ       ‚îî‚îÄ‚îÄ BackButton.tsx
‚îú‚îÄ‚îÄ hooks/                        # –ö–∞—Å—Ç–æ–º–Ω—ã–µ —Ö—É–∫–∏
‚îÇ   ‚îú‚îÄ‚îÄ useAuth.ts
‚îÇ   ‚îú‚îÄ‚îÄ useCart.ts
‚îÇ   ‚îú‚îÄ‚îÄ useRestaurants.ts
‚îÇ   ‚îú‚îÄ‚îÄ useProducts.ts
‚îÇ   ‚îú‚îÄ‚îÄ useOrders.ts
‚îÇ   ‚îú‚îÄ‚îÄ useAddresses.ts
‚îÇ   ‚îú‚îÄ‚îÄ useBonus.ts
‚îÇ   ‚îî‚îÄ‚îÄ useTelegram.ts
‚îú‚îÄ‚îÄ store/                        # –°–æ—Å—Ç–æ—è–Ω–∏–µ (Zustand/Redux)
‚îÇ   ‚îú‚îÄ‚îÄ slices/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ authSlice.ts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ cartSlice.ts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ restaurantSlice.ts
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ uiSlice.ts
‚îÇ   ‚îî‚îÄ‚îÄ store.ts
‚îú‚îÄ‚îÄ pages/                        # –°—Ç—Ä–∞–Ω–∏—Ü—ã –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
‚îÇ   ‚îú‚îÄ‚îÄ HomePage.tsx
‚îÇ   ‚îú‚îÄ‚îÄ RestaurantPage.tsx
‚îÇ   ‚îú‚îÄ‚îÄ CatalogPage.tsx
‚îÇ   ‚îú‚îÄ‚îÄ ProductPage.tsx
‚îÇ   ‚îú‚îÄ‚îÄ CartPage.tsx
‚îÇ   ‚îú‚îÄ‚îÄ CheckoutPage.tsx
‚îÇ   ‚îú‚îÄ‚îÄ OrderPage.tsx
‚îÇ   ‚îú‚îÄ‚îÄ OrdersPage.tsx
‚îÇ   ‚îú‚îÄ‚îÄ ProfilePage.tsx
‚îÇ   ‚îú‚îÄ‚îÄ AddressesPage.tsx
‚îÇ   ‚îú‚îÄ‚îÄ PromotionsPage.tsx
‚îÇ   ‚îî‚îÄ‚îÄ NotFoundPage.tsx
‚îú‚îÄ‚îÄ router/                       # –ú–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è
‚îÇ   ‚îú‚îÄ‚îÄ routes.tsx
‚îÇ   ‚îî‚îÄ‚îÄ AppRouter.tsx
‚îú‚îÄ‚îÄ styles/                       # –°—Ç–∏–ª–∏
‚îÇ   ‚îú‚îÄ‚îÄ globals.css
‚îÇ   ‚îú‚îÄ‚îÄ theme.css
‚îÇ   ‚îî‚îÄ‚îÄ components/
‚îú‚îÄ‚îÄ utils/                        # –£—Ç–∏–ª–∏—Ç—ã
‚îÇ   ‚îú‚îÄ‚îÄ formatters.ts
‚îÇ   ‚îú‚îÄ‚îÄ validators.ts
‚îÇ   ‚îú‚îÄ‚îÄ calculations.ts
‚îÇ   ‚îú‚îÄ‚îÄ geolocation.ts
‚îÇ   ‚îî‚îÄ‚îÄ telegram.ts
‚îú‚îÄ‚îÄ types/                        # TypeScript —Ç–∏–ø—ã
‚îÇ   ‚îú‚îÄ‚îÄ api.types.ts
‚îÇ   ‚îú‚îÄ‚îÄ cart.types.ts
‚îÇ   ‚îú‚îÄ‚îÄ order.types.ts
‚îÇ   ‚îú‚îÄ‚îÄ product.types.ts
‚îÇ   ‚îî‚îÄ‚îÄ user.types.ts
‚îî‚îÄ‚îÄ constants/                    # –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã
    ‚îú‚îÄ‚îÄ config.ts
    ‚îú‚îÄ‚îÄ endpoints.ts
    ‚îî‚îÄ‚îÄ messages.ts
6.2. –û—Å–Ω–æ–≤–Ω—ã–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã Mini App
6.2.1. –ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ (HomePage)
typescript
const HomePage: React.FC = () => {
  const { user, isAuthenticated } = useAuth();
  const { restaurants, loading } = useRestaurants();
  const { promotions } = usePromotions();
  const { cartItems } = useCart();

  return (
    <MainLayout>
      {/* –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ */}
      <div className="welcome-section">
        <h1>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å{user?.first_name ? `, ${user.first_name}` : ''}!</h1>
        <p>–í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ—Å—Ç–æ—Ä–∞–Ω –¥–ª—è –Ω–∞—á–∞–ª–∞ –∑–∞–∫–∞–∑–∞</p>
      </div>

      {/* –ü–æ–∏—Å–∫ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–æ–≤ */}
      <RestaurantSearch />

      {/* –ü–æ–ø—É–ª—è—Ä–Ω—ã–µ —Ä–µ—Å—Ç–æ—Ä–∞–Ω—ã */}
      <Section title="–ü–æ–ø—É–ª—è—Ä–Ω—ã–µ —Ä–µ—Å—Ç–æ—Ä–∞–Ω—ã">
        <RestaurantList restaurants={restaurants.filter(r => r.is_featured)} />
      </Section>

      {/* –ê–∫—Ü–∏–∏ */}
      {promotions.length > 0 && (
        <Section title="–ê–∫—Ü–∏–∏ –∏ —Å–ø–µ—Ü–ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è">
          <PromotionList promotions={promotions} />
        </Section>
      )}

      {/* –ë—ã—Å—Ç—Ä—ã–π –¥–æ—Å—Ç—É–ø –∫ –∫–æ—Ä–∑–∏–Ω–µ */}
      {cartItems.length > 0 && (
        <CartWidget />
      )}
    </MainLayout>
  );
};
6.2.2. –°—Ç—Ä–∞–Ω–∏—Ü–∞ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞ (RestaurantPage)
typescript
const RestaurantPage: React.FC = () => {
  const { id } = useParams<{ id: string }>();
  const { restaurant, branches, loading } = useRestaurant(id);
  const { selectedBranch, setSelectedBranch } = useRestaurantBranch();

  // –í—ã–±–æ—Ä —Ñ–∏–ª–∏–∞–ª–∞
  const handleBranchSelect = (branchId: string) => {
    setSelectedBranch(branchId);
  };

  return (
    <MainLayout>
      {/* –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–µ */}
      <RestaurantHeader restaurant={restaurant} />

      {/* –í—ã–±–æ—Ä —Ñ–∏–ª–∏–∞–ª–∞ */}
      <BranchSelector
        branches={branches}
        selectedBranch={selectedBranch}
        onSelect={handleBranchSelect}
      />

      {/* –ú–µ–Ω—é —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞ */}
      {selectedBranch && (
        <div className="restaurant-menu">
          {/* –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ */}
          <CategoryList restaurantId={id} />

          {/* –ü–æ–ø—É–ª—è—Ä–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã */}
          <ProductList
            restaurantId={id}
            filter={{ is_popular: true }}
            title="–ü–æ–ø—É–ª—è—Ä–Ω—ã–µ"
          />

          {/* –ù–æ–≤–∏–Ω–∫–∏ */}
          <ProductList
            restaurantId={id}
            filter={{ is_new: true }}
            title="–ù–æ–≤–∏–Ω–∫–∏"
          />
        </div>
      )}

      {/* –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –¥–æ—Å—Ç–∞–≤–∫–µ */}
      {selectedBranch && (
        <DeliveryInfo branch={selectedBranch} />
      )}
    </MainLayout>
  );
};
6.2.3. –°—Ç—Ä–∞–Ω–∏—Ü–∞ —Ç–æ–≤–∞—Ä–∞ (ProductPage)
typescript
const ProductPage: React.FC = () => {
  const { id } = useParams<{ id: string }>();
  const { product, loading } = useProduct(id);
  const { addToCart } = useCart();
  const [quantity, setQuantity] = useState(1);
  const [selectedOptions, setSelectedOptions] = useState<SelectedOptions>({});

  // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ –∫–æ—Ä–∑–∏–Ω—É
  const handleAddToCart = () => {
    addToCart({
      productId: product.id,
      quantity,
      selectedOptions: Object.values(selectedOptions)
    });

    // –ü–æ–∫–∞–∑–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
    showToast('–¢–æ–≤–∞—Ä –¥–æ–±–∞–≤–ª–µ–Ω –≤ –∫–æ—Ä–∑–∏–Ω—É', 'success');
  };

  // –í—ã–±–æ—Ä –æ–ø—Ü–∏–π
  const handleOptionSelect = (optionId: string, valueIds: string[]) => {
    setSelectedOptions(prev => ({
      ...prev,
      [optionId]: { optionId, valueIds }
    }));
  };

  return (
    <MainLayout>
      {/* –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞ */}
      <ProductGallery images={product.image_urls} />

      {/* –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è */}
      <div className="product-info">
        <h1>{product.name}</h1>
        <p className="description">{product.description}</p>

        {/* –•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ */}
        <ProductAttributes
          weight={product.weight_grams}
          calories={product.calories}
          cookingTime={product.cooking_time_minutes}
        />

        {/* –¢–µ–≥–∏ */}
        <ProductTags tags={product.tags} />

        {/* –¶–µ–Ω–∞ */}
        <div className="price-section">
          <span className="current-price">{formatPrice(product.price)}</span>
          {product.old_price && (
            <span className="old-price">{formatPrice(product.old_price)}</span>
          )}
        </div>

        {/* –û–ø—Ü–∏–∏ */}
        <ProductOptions
          options={product.options}
          selectedOptions={selectedOptions}
          onSelect={handleOptionSelect}
        />

        {/* –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ */}
        <QuantitySelector
          value={quantity}
          min={1}
          max={product.stock_quantity}
          onChange={setQuantity}
        />

        {/* –ö–Ω–æ–ø–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è */}
        <Button
          onClick={handleAddToCart}
          disabled={!product.in_stock}
          fullWidth
          size="large"
        >
          {product.in_stock ? '–î–æ–±–∞–≤–∏—Ç—å –≤ –∫–æ—Ä–∑–∏–Ω—É' : '–ù–µ—Ç –≤ –Ω–∞–ª–∏—á–∏–∏'}
        </Button>
      </div>
    </MainLayout>
  );
};
6.2.4. –°—Ç—Ä–∞–Ω–∏—Ü–∞ –∫–æ—Ä–∑–∏–Ω—ã (CartPage)
typescript
const CartPage: React.FC = () => {
  const { cartItems, updateQuantity, removeItem, clearCart, total } = useCart();
  const { user } = useAuth();
  const [promoCode, setPromoCode] = useState('');
  const [promoDiscount, setPromoDiscount] = useState(0);
  const [bonusToUse, setBonusToUse] = useState(0);

  // –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –ø—Ä–æ–º–æ–∫–æ–¥–∞
  const handleApplyPromo = async () => {
    try {
      const discount = await validatePromoCode(promoCode, total);
      setPromoDiscount(discount);
      showToast('–ü—Ä–æ–º–æ–∫–æ–¥ –ø—Ä–∏–º–µ–Ω–µ–Ω', 'success');
    } catch (error) {
      showToast(error.message, 'error');
    }
  };

  // –ü–µ—Ä–µ—Ö–æ–¥ –∫ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—é
  const handleCheckout = () => {
    if (!user) {
      // –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é
      navigate('/auth');
      return;
    }

    if (cartItems.length === 0) {
      showToast('–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞', 'warning');
      return;
    }

    navigate('/checkout');
  };

  return (
    <MainLayout title="–ö–æ—Ä–∑–∏–Ω–∞">
      {cartItems.length === 0 ? (
        <EmptyState
          icon="üõí"
          title="–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞"
          description="–î–æ–±–∞–≤—å—Ç–µ —Ç–æ–≤–∞—Ä—ã –∏–∑ –º–µ–Ω—é —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞"
          action={
            <Button onClick={() => navigate('/')}>
              –í—ã–±—Ä–∞—Ç—å —Ä–µ—Å—Ç–æ—Ä–∞–Ω
            </Button>
          }
        />
      ) : (
        <>
          {/* –°–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä–æ–≤ */}
          <CartList
            items={cartItems}
            onUpdateQuantity={updateQuantity}
            onRemove={removeItem}
          />

          {/* –ü—Ä–æ–º–æ–∫–æ–¥ */}
          <div className="promo-section">
            <Input
              value={promoCode}
              onChange={setPromoCode}
              placeholder="–í–≤–µ–¥–∏—Ç–µ –ø—Ä–æ–º–æ–∫–æ–¥"
              size="small"
            />
            <Button onClick={handleApplyPromo} size="small">
              –ü—Ä–∏–º–µ–Ω–∏—Ç—å
            </Button>
          </div>

          {/* –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –±–æ–Ω—É—Å–æ–≤ */}
          {user?.bonus_balance > 0 && (
            <BonusUsage
              maxBonus={user.bonus_balance}
              bonusPercentAllowed={user.bonus_percent_allowed}
              total={total}
              value={bonusToUse}
              onChange={setBonusToUse}
            />
          )}

          {/* –ò—Ç–æ–≥–æ */}
          <CartTotal
            subtotal={total}
            deliveryFee={0} // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –Ω–∞ —ç—Ç–∞–ø–µ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è
            discount={promoDiscount}
            bonusUsed={bonusToUse}
            total={total - promoDiscount - bonusToUse}
          />

          {/* –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π */}
          <div className="cart-actions">
            <Button
              variant="outline"
              onClick={clearCart}
            >
              –û—á–∏—Å—Ç–∏—Ç—å –∫–æ—Ä–∑–∏–Ω—É
            </Button>
            <Button
              onClick={handleCheckout}
              fullWidth
              size="large"
            >
              –û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑
            </Button>
          </div>
        </>
      )}
    </MainLayout>
  );
};
6.2.5. –°—Ç—Ä–∞–Ω–∏—Ü–∞ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞ (CheckoutPage)
typescript
const CheckoutPage: React.FC = () => {
  const { cartItems, total } = useCart();
  const { user } = useAuth();
  const [step, setStep] = useState(1);
  const [orderType, setOrderType] = useState<'delivery' | 'pickup'>('delivery');
  const [selectedBranch, setSelectedBranch] = useState<string>();
  const [selectedAddress, setSelectedAddress] = useState<string>();
  const [deliveryTime, setDeliveryTime] = useState<string>();
  const [paymentMethod, setPaymentMethod] = useState<string>('card_online');
  const [customerComment, setCustomerComment] = useState('');

  // –ü–æ–ª—É—á–µ–Ω–∏–µ —Ñ–∏–ª–∏–∞–ª–æ–≤ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞
  const { branches } = useRestaurantBranches();

  // –ü–æ–ª—É—á–µ–Ω–∏–µ –∞–¥—Ä–µ—Å–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  const { addresses } = useAddresses();

  // –†–∞—Å—á–µ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –¥–æ—Å—Ç–∞–≤–∫–∏
  const deliveryFee = useDeliveryFee(selectedBranch, selectedAddress);

  // –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞
  const handleCreateOrder = async () => {
    try {
      const orderData: CreateOrderData = {
        branch_id: selectedBranch!,
        order_type: orderType,
        items: cartItems.map(item => ({
          product_id: item.product.id,
          quantity: item.quantity,
          selected_options: item.selectedOptions
        })),
        delivery_address_id: orderType === 'delivery' ? selectedAddress : undefined,
        preferred_delivery_time: deliveryTime,
        payment_method: paymentMethod,
        customer_comment: customerComment
      };

      const order = await createOrder(orderData);

      // –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –æ–ø–ª–∞—Ç—ã –∏–ª–∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
      if (paymentMethod === 'card_online') {
        navigate(`/order/${order.id}/payment`);
      } else {
        navigate(`/order/${order.id}/success`);
      }
    } catch (error) {
      showToast(error.message, 'error');
    }
  };

  // –®–∞–≥–∏ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è
  const steps = [
    { id: 1, title: '–¢–∏–ø –∑–∞–∫–∞–∑–∞', component: <OrderTypeStep /> },
    { id: 2, title: '–í—ã–±–æ—Ä —Ñ–∏–ª–∏–∞–ª–∞', component: <BranchStep /> },
    { id: 3, title: '–ê–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏', component: <AddressStep /> },
    { id: 4, title: '–í—Ä–µ–º—è –ø–æ–ª—É—á–µ–Ω–∏—è', component: <TimeStep /> },
    { id: 5, title: '–û–ø–ª–∞—Ç–∞', component: <PaymentStep /> },
    { id: 6, title: '–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ', component: <ConfirmationStep /> },
  ];

  return (
    <MainLayout title="–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞">
      {/* –ü—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä */}
      <Stepper steps={steps} currentStep={step} />

      {/* –ö–æ–Ω—Ç–µ–Ω—Ç —à–∞–≥–∞ */}
      <div className="checkout-content">
        {steps[step - 1].component}
      </div>

      {/* –ù–∞–≤–∏–≥–∞—Ü–∏—è */}
      <div className="checkout-navigation">
        {step > 1 && (
          <Button onClick={() => setStep(step - 1)} variant="outline">
            –ù–∞–∑–∞–¥
          </Button>
        )}

        {step < steps.length ? (
          <Button onClick={() => setStep(step + 1)}>
            –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å
          </Button>
        ) : (
          <Button onClick={handleCreateOrder} loading={isCreating}>
            –ó–∞–∫–∞–∑–∞—Ç—å
          </Button>
        )}
      </div>

      {/* –ò—Ç–æ–≥–æ–≤–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è */}
      <OrderSummary
        items={cartItems}
        orderType={orderType}
        deliveryFee={deliveryFee}
        total={total + deliveryFee}
      />
    </MainLayout>
  );
};
6.2.6. –°—Ç—Ä–∞–Ω–∏—Ü–∞ –ø—Ä–æ—Ñ–∏–ª—è (ProfilePage)
typescript
const ProfilePage: React.FC = () => {
  const { user, logout } = useAuth();
  const { orders } = useOrders();
  const [activeTab, setActiveTab] = useState<'info' | 'orders' | 'bonus' | 'addresses'>('info');

  return (
    <MainLayout title="–ü—Ä–æ—Ñ–∏–ª—å">
      {/* –ó–∞–≥–æ–ª–æ–≤–æ–∫ –ø—Ä–æ—Ñ–∏–ª—è */}
      <div className="profile-header">
        <Avatar
          src={user?.photo_url}
          name={user?.first_name}
          size="large"
        />
        <div className="profile-info">
          <h2>{user?.first_name} {user?.last_name}</h2>
          <p>@{user?.username}</p>
          <p className="registration-date">
            –° –Ω–∞–º–∏ —Å {formatDate(user?.registration_date)}
          </p>
        </div>
      </div>

      {/* –ë–æ–Ω—É—Å–Ω—ã–π –±–∞–ª–∞–Ω—Å */}
      <BonusBalance balance={user?.bonus_balance || 0} />

      {/* –¢–∞–±—ã */}
      <Tabs value={activeTab} onChange={setActiveTab}>
        <Tab value="info" label="–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è" />
        <Tab value="orders" label="–ú–æ–∏ –∑–∞–∫–∞–∑—ã" />
        <Tab value="bonus" label="–ë–æ–Ω—É—Å—ã" />
        <Tab value="addresses" label="–ê–¥—Ä–µ—Å–∞" />
      </Tabs>

      {/* –ö–æ–Ω—Ç–µ–Ω—Ç —Ç–∞–±–æ–≤ */}
      <div className="profile-content">
        {activeTab === 'info' && <ProfileInfo user={user} />}
        {activeTab === 'orders' && <OrderHistory orders={orders} />}
        {activeTab === 'bonus' && <BonusHistory userId={user?.id} />}
        {activeTab === 'addresses' && <AddressList />}
      </div>

      {/* –î–µ–π—Å—Ç–≤–∏—è */}
      <div className="profile-actions">
        <Button variant="outline" onClick={logout}>
          –í—ã–π—Ç–∏
        </Button>
      </div>
    </MainLayout>
  );
};
6.3. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Telegram WebApp
typescript
// hooks/useTelegram.ts
export const useTelegram = () => {
  const [webApp, setWebApp] = useState<WebApp | null>(null);
  const [user, setUser] = useState<TelegramUser | null>(null);
  const [initData, setInitData] = useState<string>('');

  useEffect(() => {
    if (typeof window !== 'undefined' && window.Telegram?.WebApp) {
      const tg = window.Telegram.WebApp;

      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
      tg.ready();
      tg.expand();

      // –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
      setWebApp(tg);
      setUser(tg.initDataUnsafe?.user || null);
      setInitData(tg.initData || '');

      // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ UI
      tg.setHeaderColor('#4e73df');
      tg.setBackgroundColor('#f8f9fa');
      tg.enableClosingConfirmation();

      // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
      tg.onEvent('viewportChanged', handleViewportChange);
      tg.onEvent('themeChanged', handleThemeChange);

      return () => {
        tg.offEvent('viewportChanged', handleViewportChange);
        tg.offEvent('themeChanged', handleThemeChange);
      };
    }
  }, []);

  // –û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –≤ –±–æ—Ç–∞
  const sendDataToBot = (data: any) => {
    if (webApp) {
      webApp.sendData(JSON.stringify(data));
    }
  };

  // –ó–∞–∫—Ä—ã—Ç–∏–µ Mini App
  const closeApp = () => {
    if (webApp) {
      webApp.close();
    }
  };

  // –ü–æ–∫–∞–∑–∞—Ç—å –∞–ª–µ—Ä—Ç
  const showAlert = (message: string) => {
    if (webApp) {
      webApp.showAlert(message);
    }
  };

  // –ü–æ–∫–∞–∑–∞—Ç—å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
  const showConfirm = (message: string): Promise<boolean> => {
    return new Promise((resolve) => {
      if (webApp) {
        webApp.showConfirm(message, (confirmed) => {
          resolve(confirmed);
        });
      } else {
        resolve(false);
      }
    });
  };

  return {
    webApp,
    user,
    initData,
    isTelegram: !!webApp,
    sendDataToBot,
    closeApp,
    showAlert,
    showConfirm,
    themeParams: webApp?.themeParams || {},
    viewportHeight: webApp?.viewportHeight || 0,
    viewportStableHeight: webApp?.viewportStableHeight || 0,
  };
};

// –ö–æ–º–ø–æ–Ω–µ–Ω—Ç –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ Telegram
export const TelegramAuth: React.FC<{ children: React.ReactNode }> = ({ children }) => {
  const { isTelegram, initData } = useTelegram();
  const { loginWithTelegram, isAuthenticated, isLoading } = useAuth();
  const [authStatus, setAuthStatus] = useState<'checking' | 'success' | 'error'>('checking');

  useEffect(() => {
    const authenticate = async () => {
      if (!isTelegram || !initData) {
        setAuthStatus('error');
        return;
      }

      try {
        await loginWithTelegram(initData);
        setAuthStatus('success');
      } catch (error) {
        console.error('Telegram auth error:', error);
        setAuthStatus('error');
      }
    };

    authenticate();
  }, [isTelegram, initData, loginWithTelegram]);

  if (isLoading || authStatus === 'checking') {
    return <PageLoader message="–ü—Ä–æ–≤–µ—Ä–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏..." />;
  }

  if (!isTelegram || authStatus === 'error') {
    return (
      <ErrorState
        title="–¢—Ä–µ–±—É–µ—Ç—Å—è Telegram"
        description="–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–∫—Ä–æ–π—Ç–µ —ç—Ç–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —á–µ—Ä–µ–∑ Telegram"
      />
    );
  }

  if (!isAuthenticated) {
    return <PageLoader message="–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏..." />;
  }

  return <>{children}</>;
};
6.4. –°–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (Zustand)
typescript
// store/cartSlice.ts
interface CartState {
  items: CartItem[];
  restaurantId: string | null;
  branchId: string | null;

  // Actions
  addItem: (item: AddCartItem) => void;
  updateQuantity: (itemId: string, quantity: number) => void;
  removeItem: (itemId: string) => void;
  clearCart: () => void;
  setRestaurant: (restaurantId: string, branchId: string) => void;

  // Getters
  total: number;
  itemCount: number;
  isFromSameRestaurant: (restaurantId: string) => boolean;
}

export const useCartStore = create<CartState>((set, get) => ({
  items: [],
  restaurantId: null,
  branchId: null,

  addItem: (item) => {
    const state = get();

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞
    if (state.restaurantId && state.restaurantId !== item.restaurantId) {
      // –ü–æ–∫–∞–∑–∞—Ç—å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –æ—á–∏—Å—Ç–∫–∏ –∫–æ—Ä–∑–∏–Ω—ã
      if (confirm('–ö–æ—Ä–∑–∏–Ω–∞ —Å–æ–¥–µ—Ä–∂–∏—Ç —Ç–æ–≤–∞—Ä—ã –∏–∑ –¥—Ä—É–≥–æ–≥–æ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞. –û—á–∏—Å—Ç–∏—Ç—å –∫–æ—Ä–∑–∏–Ω—É?')) {
        set({
          items: [],
          restaurantId: item.restaurantId,
          branchId: item.branchId,
        });
      } else {
        return;
      }
    }

    // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞
    const existingItem = state.items.find(i =>
      i.productId === item.productId &&
      isEqual(i.selectedOptions, item.selectedOptions)
    );

    if (existingItem) {
      // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ —Ç–æ–≤–∞—Ä–∞
      set({
        items: state.items.map(i =>
          i.id === existingItem.id
            ? { ...i, quantity: i.quantity + item.quantity }
            : i
        )
      });
    } else {
      // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —Ç–æ–≤–∞—Ä–∞
      set({
        items: [...state.items, {
          id: uuid(),
          ...item,
          addedAt: new Date().toISOString()
        }],
        restaurantId: item.restaurantId,
        branchId: item.branchId,
      });
    }
  },

  updateQuantity: (itemId, quantity) => {
    const state = get();

    if (quantity <= 0) {
      get().removeItem(itemId);
      return;
    }

    set({
      items: state.items.map(item =>
        item.id === itemId ? { ...item, quantity } : item
      )
    });
  },

  removeItem: (itemId) => {
    const state = get();

    set({
      items: state.items.filter(item => item.id !== itemId)
    });

    // –ï—Å–ª–∏ –∫–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞, —Å–±—Ä–æ—Å–∏—Ç—å —Ä–µ—Å—Ç–æ—Ä–∞–Ω
    if (state.items.length === 1) {
      set({ restaurantId: null, branchId: null });
    }
  },

  clearCart: () => {
    set({ items: [], restaurantId: null, branchId: null });
  },

  setRestaurant: (restaurantId, branchId) => {
    set({ restaurantId, branchId });
  },

  // Getters
  get total() {
    return get().items.reduce((sum, item) => {
      const itemTotal = item.product.price * item.quantity;
      const optionsTotal = item.selectedOptions.reduce((optSum, option) => {
        return optSum + option.values.reduce((valSum, value) =>
          valSum + (value.price_modifier || 0), 0
        );
      }, 0);
      return sum + (itemTotal + optionsTotal) * item.quantity;
    }, 0);
  },

  get itemCount() {
    return get().items.reduce((count, item) => count + item.quantity, 0);
  },

  isFromSameRestaurant: (restaurantId) => {
    const state = get();
    return state.restaurantId === restaurantId;
  }
}));

// store/authSlice.ts
interface AuthState {
  user: User | null;
  token: string | null;
  isAuthenticated: boolean;
  isLoading: boolean;

  // Actions
  login: (user: User, token: string) => void;
  logout: () => void;
  updateUser: (user: Partial<User>) => void;
  setLoading: (loading: boolean) => void;
}

export const useAuthStore = create<AuthState>((set) => ({
  user: null,
  token: null,
  isAuthenticated: false,
  isLoading: true,

  login: (user, token) => {
    // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ localStorage
    localStorage.setItem('auth_token', token);
    localStorage.setItem('user', JSON.stringify(user));

    set({
      user,
      token,
      isAuthenticated: true,
      isLoading: false
    });
  },

  logout: () => {
    // –û—á–∏—Å—Ç–∫–∞ localStorage
    localStorage.removeItem('auth_token');
    localStorage.removeItem('user');

    set({
      user: null,
      token: null,
      isAuthenticated: false,
      isLoading: false
    });
  },

  updateUser: (updates) => {
    set((state) => ({
      user: state.user ? { ...state.user, ...updates } : null
    }));

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤ localStorage
    const storedUser = localStorage.getItem('user');
    if (storedUser) {
      const user = JSON.parse(storedUser);
      localStorage.setItem('user', JSON.stringify({ ...user, ...updates }));
    }
  },

  setLoading: (loading) => {
    set({ isLoading: loading });
  }
}));

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
export const initializeAuth = () => {
  const token = localStorage.getItem('auth_token');
  const userStr = localStorage.getItem('user');

  if (token && userStr) {
    try {
      const user = JSON.parse(userStr);
      useAuthStore.getState().login(user, token);
    } catch (error) {
      console.error('Error parsing stored user:', error);
      localStorage.removeItem('auth_token');
      localStorage.removeItem('user');
    }
  }

  useAuthStore.getState().setLoading(false);
};
